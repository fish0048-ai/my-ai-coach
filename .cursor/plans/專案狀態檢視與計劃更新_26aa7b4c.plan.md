---
name: 專案狀態檢視與計劃更新
overview: 基於實際程式碼檢視結果，更新計劃文件以反映已完成功能、重新評估優先級，並將 AI 功能增強列為優先項目。
todos: []
---

# 專案狀態檢視與計劃更新

## 一、已完成功能確認

### 1.1 資料分析增強

#### ✅ PR (Personal Record) 追蹤 - 已完成

- **實現位置**: 
- `src/services/calendarService.js` - `extractPRs()`, `getAllPRs()`
- `src/components/Dashboard/PRTracker.jsx`
- `src/views/DashboardView.jsx` - 已整合顯示
- **功能**: 自動識別力量訓練和跑步的 PR，支援 1RM、總訓練量、最大重量、最大距離、最快配速等

#### ✅ 訓練周期分析 - 已完成

- **實現位置**: 
- `src/utils/cycleAnalysis.js` - 完整的周期分析邏輯
- `src/views/TrendAnalysisView.jsx` - 已整合顯示
- **功能**: 分析增肌期、減脂期、維持期、恢復期，提供趨勢分析和建議

### 1.2 社交與分享功能

#### ✅ 訓練成就系統 - 已完成

- **實現位置**: 
- `src/services/achievementService.js` - 13種成就類型
- `src/components/Dashboard/AchievementBadge.jsx`
- `src/components/Dashboard/AchievementPanel.jsx`
- `src/views/DashboardView.jsx` - 已整合顯示
- `src/views/CalendarView.jsx` - 訓練完成時自動檢查
- **功能**: 連續訓練、總訓練次數、跑步、力量訓練、特殊成就等

### 1.3 AI 功能增強

#### ✅ 訓練計劃推薦 - 已完成並擴展

- **實現位置**: 
- `src/services/ai/workoutGenerator.js` - `generateTrainingPlan()`, `PLAN_TYPES`
- `src/views/TrainingPlanView.jsx`
- `src/views/CalendarView.jsx` - 已整合入口
- **功能**: 
- 10種訓練計劃類型（5x5, PPL, 上下半身, 全身, 跑步新手, 5K, 半馬完賽, 全馬完賽, 半馬破PB, 全馬破PB）
- 支援目標 PB 和賽事日期設定
- 可直接應用到行事曆
- 精簡 prompt 以加速生成
- 結構化課表輸出（非文字說明）

#### ✅ 智能營養建議 - 已完成

- **實現位置**: 
- `src/services/ai/nutritionRecommendation.js` - `generateNutritionRecommendation()`
- `src/services/ai/localAnalysisRules.js` - `NUTRITION_RULES`（本地分析規則）
- `src/views/NutritionView.jsx` - 已整合智能建議卡片
- **功能**: 
- 基於今日訓練強度和時間，推薦飲食計劃
- 分析營養攝入與訓練目標的匹配度
- 提供食譜建議和營養缺口提醒
- 本地規則優先，減少 AI token 消耗

#### ✅ 動作糾正助手 - 已完成

- **實現位置**: 
- `src/services/ai/formCorrection.js` - `analyzeFormDeviations()`, `generateFormCorrection()`
- `src/services/ai/localAnalysisRules.js` - `FORM_CORRECTION_RULES`（本地分析規則）
- `src/views/StrengthAnalysisView.jsx` - 已整合動作偏差分析和糾正建議
- **功能**: 
- 即時分析動作影片，提供具體糾正建議
- 對比標準動作，指出偏差角度和位置
- 生成糾正訓練計劃
- 本地規則優先，減少 AI token 消耗

### 1.4 資料管理與分享功能

#### ✅ 訓練日誌分享 - 已完成

- **實現位置**: 
- `src/utils/reportGenerator.js` - 報告生成工具
- `src/views/DashboardView.jsx` - 已整合分享按鈕和選單
- **功能**: 
- 生成訓練報告（JSON/CSV/圖片）
- 複製文字報告到剪貼簿
- 下載圖片報告
- 匯出訓練資料（JSON/CSV）

#### ✅ 資料備份與恢復 - 已完成

- **實現位置**: 
- `src/services/backupService.js` - 備份和恢復服務
- `src/views/FeatureViews.jsx` - Profile 頁面已整合備份/恢復功能
- **功能**: 
- 一鍵匯出所有資料（JSON 格式）
- 支援資料恢復（包含驗證和錯誤處理）
- 備份包含：profile, calendar, body_logs, food_logs, gears, achievements

### 1.5 平台整合與移動端

#### ✅ 多平台資料同步 - 已完成（檔案匯入部分）

- **實現位置**: 
- `src/services/import/platformSync.js` - 多平台解析服務
- `src/services/importService.js` - 已整合 platformSync 解析函式
- **功能**: 
- 支援匯入 Strava CSV
- 支援匯入 Garmin 等通用 CSV
- 統一資料格式
- API 同步介面已預留（待申請 API 權限）

#### ✅ PWA 支援 - 已完成

- **實現位置**: 
- `public/manifest.json` - PWA 配置
- `public/sw.js` - Service Worker
- `index.html` - 已引用 manifest
- `src/main.jsx` - 已註冊 Service Worker
- **功能**: 
- 支援離線使用（基本快取策略）
- 可添加到主螢幕
- 提升移動端體驗

#### ✅ 響應式設計優化 - 已完成

- **實現位置**: 
- `src/views/CalendarView.jsx` - 已優化響應式布局
- 各頁面已使用 Tailwind 響應式類
- **功能**: 
- 優化移動端佈局
- 改進觸摸交互
- 適配小螢幕顯示

## 二、已完成功能總結

## 三、未來擴展功能（待規劃）

### 3.1 多平台 API 同步

**功能描述**:

- 透過 Strava、Garmin Connect、Apple Health 官方 API 自動同步資料
- 需要申請各平台 API 權限和 OAuth 流程

**實現要點**:

- 擴展 `src/services/import/platformSync.js` 的 `syncFromPlatformAPI()` 函數
- 實現 OAuth 授權流程
- 添加同步設定頁面
- 需要申請各平台 API 權限

**預期收益**: 提高資料匯入便利性，實現自動同步

---

### 3.2 PDF 報告生成

**功能描述**:

- 使用 jsPDF 生成訓練報告 PDF
- 需要安裝 jsPDF 依賴

**實現要點**:

- 安裝 `jspdf` 套件
- 擴展 `src/utils/reportGenerator.js` 添加 PDF 生成功能
- 在分享選單中添加「下載 PDF 報告」選項

**預期收益**: 提供更專業的報告格式

---

### 3.3 定期備份提醒

**功能描述**:

- 定期提醒用戶備份資料
- 可設定提醒頻率

**實現要點**:

- 在 `backupService.js` 中添加提醒邏輯
- 使用瀏覽器通知 API 或應用內提醒
- 記錄最後備份時間

**預期收益**: 提升用戶資料安全性

---

## 四、技術債務與優化

### 已完成優化 ✅

- ✅ 統一錯誤處理機制（`errorService.js`）
- ✅ CalendarView 重構（AI 生成邏輯已抽離到 `workoutGenerator.js`，WeeklyModal 已拆分）
- ✅ 資料快取策略（`calendarService.js` 已實現快取）
- ✅ 狀態管理優化（zustand 已集成）
- ✅ 代碼分割優化（MediaPipe 延遲加載）
- ✅ 加載狀態優化（Skeleton 組件已創建）
- ✅ 表單驗證增強（`formValidation.js` 已創建）
- ✅ AI Token 優化（本地分析規則庫，減少 API 調用）

### 待改進項目

- ~~[ ] **強化物理計算單元測試**（優先級：高）- 詳見「六、專業化增強功能」6.2~~
- [ ] 添加 E2E 測試（Playwright 或 Cypress）
- [ ] 完善 README.md 文檔
- [ ] TypeScript 遷移（可選）
- [ ] 性能監控和錯誤追蹤（Sentry）
- [ ] CI/CD 流程完善

---

## 五、實施建議

### ✅ 已完成項目

1. ✅ **智能營養建議** - 已完成，整合訓練資料，本地規則優先
2. ✅ **動作糾正助手** - 已完成，提供具體糾正建議和訓練計劃
3. ✅ **訓練日誌分享** - 已完成，支援 JSON/CSV/圖片報告
4. ✅ **資料備份與恢復** - 已完成，一鍵匯出和恢復功能
5. ✅ **多平台資料同步（檔案匯入）** - 已完成，支援 Strava/Garmin CSV 匯入
6. ✅ **PWA 支援** - 已完成，基本離線快取和主螢幕添加
7. ✅ **響應式設計優化** - 已完成，優化移動端佈局

### 未來擴展項目

1. **多平台 API 同步** - 需要申請 API 權限和實現 OAuth 流程
2. **PDF 報告生成** - 需要安裝 jsPDF 套件
3. **定期備份提醒** - 可選功能，提升用戶體驗

---

## 六、專業化增強功能（從好用到專業）

以下三個功能補強能讓產品從「好用」提升到「專業」水準，建議優先實施。

### ~~6.1 引入 RPE (自覺強度) 與訓練壓力指數 (TSS/Trimp)~~（已完成）

**現狀問題**:

- 目前訓練負荷評估僅依靠距離、時間、心率等外部指標
- **盲點**：數據有時會說謊（例如：天氣熱導致心率偏高，但實際疲勞度不高；或心率正常但肌肉極度疲勞）
- 缺乏「內部負荷」的量化指標，無法真實反映訓練對身體的實際壓力

**功能描述**:

- 在 `WorkoutForm`（單筆訓練編輯表單）中加入 **RPE (Rate of Perceived Exertion, 自覺強度)** 滑桿（1-10 分）
- 實作簡單的 **Training Load = RPE × 時間(分鐘)** 計算公式
- 可選：進階實作 **TSS (Training Stress Score)** 或 **TRIMP (Training Impulse)** 算法
- 將 RPE 和 Training Load 整合到訓練週期分析中，用於判斷過度訓練風險

**實現要點**:

- **UI 修改**:
  - 在 `src/components/Calendar/WorkoutForm.jsx` 中添加 RPE 滑桿組件
  - 位置建議：放在「核心資料」區塊，與時間、距離、心率並列
  - 滑桿範圍：1-10，顯示對應文字說明（1=極輕鬆，10=極限）
- **資料結構**:
  - 在 `calendarService.js` 的 workout 物件中添加 `rpe` 和 `trainingLoad` 欄位
  - 更新 Firestore schema（向後相容，設為可選欄位）
- **計算邏輯**:
  - 在 `src/utils/workoutCalculations.js` 中添加 `calculateTrainingLoad(rpe, durationMinutes)` 函數
  - 可選：實作 `calculateTSS()` 或 `calculateTRIMP()` 進階算法
- **AI 整合**:
  - 更新 `cycleAnalysis.js` 的過度訓練判斷邏輯，納入 Training Load 趨勢
  - 在 AI 教練建議中，當 Training Load 持續偏高時，提醒用戶注意恢復

**預期收益**:

- 更準確的訓練負荷評估，補足外部指標的盲點
- 提升 AI 教練判斷「過度訓練」的準確度
- 符合專業教練的評估標準，增加產品專業度

**優先級**: 🔴 高（核心功能增強）

---

### ~~6.2 強化「物理計算」的單元測試 (Unit Testing)~~（已完成）

**現狀問題**:

- 計劃中雖提到測試，但未指明重點和覆蓋範圍
- **盲點**：`utils/nutritionCalculations.js` 和 `src/services/ai/formCorrection.js` 包含大量數學與邏輯計算
- 如果 TDEE 算錯 500 卡，或深蹲角度判斷錯誤，會直接導致訓練失效或受傷風險
- 目前缺乏測試保護，重構或修改時容易引入錯誤

**功能描述**:

- 優先為 `src/utils/` 資料夾下的所有 `.js` 檔案撰寫 **Vitest** 或 **Jest** 單元測試
- 目標測試覆蓋率：**至少 80%**
- 重點測試項目：
  - `nutritionCalculations.js`: BMR、TDEE、目標卡路里計算
  - `workoutCalculations.js`: 1RM、訓練量、Training Load 計算
  - `heartRateCalculations.js`: 心率區間、最大心率計算
  - `cycleAnalysis.js`: 訓練週期判斷邏輯
  - `formCorrection.js`: 動作角度偏差計算（如果可測試）

**實現要點**:

- **測試框架設定**:
  - 安裝 `vitest` 或 `jest`（建議使用 Vitest，與 Vite 整合更好）
  - 在 `package.json` 中添加測試腳本：`"test": "vitest"`, `"test:coverage": "vitest --coverage"`
- **測試檔案結構**:
  - 為每個 `utils/*.js` 檔案創建對應的 `utils/*.test.js` 或 `utils/__tests__/*.test.js`
  - 範例：`src/utils/nutritionCalculations.test.js`
- **測試案例範例**:
  ```javascript
  // nutritionCalculations.test.js
  describe('calculateBMR', () => {
    it('應正確計算 70kg 男性 BMR', () => {
      const result = calculateBMR(70, 175, 30, 'male');
      expect(result).toBeCloseTo(1707.5, 1); // 預期值需根據公式驗證
    });
    
    it('應正確計算 60kg 女性 BMR', () => {
      const result = calculateBMR(60, 165, 25, 'female');
      expect(result).toBeCloseTo(1324, 1);
    });
  });
  
  describe('calculateTDEE', () => {
    it('應正確計算高活動量 TDEE', () => {
      const bmr = calculateBMR(70, 175, 30, 'male');
      const tdee = calculateTDEE({ bmr, activityLevel: 'very_active' });
      expect(tdee).toBeCloseTo(bmr * 1.725, 1);
    });
  });
  ```

- **邊界條件測試**:
  - 測試極端值（體重 0、負數、超大值）
  - 測試缺失參數（undefined、null）
  - 測試類型錯誤（字串而非數字）

**預期收益**:

- 確保核心計算邏輯的正確性，避免營養或訓練建議錯誤
- 提升程式碼品質和可維護性
- 重構時有測試保護，降低引入 bug 風險
- 符合專業軟體開發標準

**優先級**: 🔴 高（品質保證基礎）

---

### ~~6.3 隱私與影片處理的明確宣告~~（已完成）

**現狀問題**:

- 使用了 MediaPipe（動作分析）與 Gemini Vision（AI 視覺分析）
- **盲點**：使用者上傳健身影片極度敏感，若未明確說明隱私處理方式，會降低使用者信任
- 目前 UI 上缺乏明確的隱私宣告，使用者可能擔心影片被上傳到伺服器

**功能描述**:

- **技術確認**：確認 MediaPipe 的推論是在 **Client 端（瀏覽器）** 完成，而非上傳伺服器
- **UI 明確標註**：在動作分析頁面（`StrengthAnalysisView.jsx`）添加隱私宣告
- **宣告內容**：
  - 「您的動作分析影片僅在本地運算，不會儲存於雲端」
  - 「MediaPipe 分析在您的裝置上完成，影片不會上傳」
  - 「僅當使用 AI 深度分析時，會上傳截圖至 Gemini API（可選功能）」

**實現要點**:

- **技術審查**:
  - 檢查 `src/hooks/usePoseDetection.js` 確認 MediaPipe 是否完全在本地運行
  - 檢查 `src/services/ai/formCorrection.js` 確認 Gemini Vision API 調用時，是否只上傳截圖而非完整影片
  - 確認 Firestore 中沒有儲存影片檔案（只儲存分析結果）
- **UI 修改**:
  - 在 `src/views/StrengthAnalysisView.jsx` 的影片上傳區域添加隱私宣告卡片
  - 設計建議：使用 `Info` 圖示 + 淺色背景的提示框
  - 位置：放在「上傳影片」按鈕下方或側邊
- **宣告文案範例**:
  ```jsx
  <div className="bg-blue-900/20 border border-blue-700 rounded-lg p-3 text-sm text-blue-200">
    <div className="flex items-start gap-2">
      <ShieldCheck size={16} className="mt-0.5 flex-shrink-0" />
      <div>
        <p className="font-semibold mb-1">隱私保護</p>
        <p>您的動作分析影片僅在本地運算，不會儲存於雲端。MediaPipe 分析在您的裝置上完成，影片不會上傳至任何伺服器。</p>
        <p className="mt-2 text-xs text-blue-300">僅當使用 AI 深度分析時，會上傳截圖至 Gemini API（可選功能）。</p>
      </div>
    </div>
  </div>
  ```

- **可選增強**:
  - 在設定頁面添加「隱私政策」連結
  - 在首次使用動作分析時，顯示隱私說明彈窗（可勾選「不再顯示」）

**預期收益**:

- 大幅增加使用者信任感，特別是對隱私敏感的使用者
- 符合 GDPR 等隱私法規要求（明確告知資料處理方式）
- 提升產品專業度和透明度
- 減少使用者因隱私疑慮而放棄使用功能的情況

**優先級**: 🟡 中高（信任度提升）

---

### 實施順序建議

1. **第一階段**（立即實施）:

   - 6.3 隱私與影片處理的明確宣告（實施簡單，效果明顯）
   - 6.1 RPE 與訓練壓力指數（核心功能增強）

2. **第二階段**（1-2 週內）:

   - 6.2 強化物理計算單元測試（需要時間撰寫測試案例，但對長期品質至關重要）

3. **持續優化**:

   - 根據測試覆蓋率報告，逐步補齊邊界條件測試
   - 根據使用者反饋，調整 RPE 的 UI 和計算公式