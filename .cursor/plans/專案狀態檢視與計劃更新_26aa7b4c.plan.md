---
name: ""
overview: ""
todos: []
isProject: false
---

# 專案狀態檢視與計劃更新

> **最後更新時間**：2025-01-24
> **專案狀態**：🟡 重構進行中

## 📊 專案整體進度

### ✅ 已完成項目

1. **工具庫統一** - `utils/date.js`、`utils/number.js`、`utils/aiJson.js` 已建立並使用
2. **API Key 管理遷移** - `apiKeyService.js` 和 `useApiKey.js` 已建立，所有直接使用 localStorage 的地方已遷移
3. **AI 服務層建立** - `workoutGenerator.js`、`coachService.js`、`analysisService.js` 已建立
4. **API 層骨架** - `api/workouts.js`、`api/nutrition.js`、`api/body.js`、`api/gears.js` 已建立
5. **PR 服務抽離** - `services/workout/prService.js` 已建立
6. **使用者本地硬碟瘦身** - 影片 / CSV Blob URL 即時回收，減輕本機記憶體與磁碟負擔（見下方章節；Firebase 容量不納入）
7. **任務 2-1：抽離檔案解析服務** - `fitParser.js`、`csvParser.js` 已存在；CalendarView 移除未使用 FitParser、改從 `importService` 匯入；Run/Strength 分析 View 已使用 `fitParser.extractFITMetrics`

---

## 📋 待完成任務清單

### 🔧 階段二：業務邏輯抽離與服務層建立

#### ~~任務 2-1：抽離檔案解析服務~~（已完成）

**目標**

- 從 `CalendarView.jsx` 抽出 FIT/CSV 檔案解析邏輯至獨立服務
- 讓 View 專注於 UI 互動，檔案處理邏輯集中管理

**修改檔案**

- 🆕 新增：`src/services/import/fitParser.js`
- 從 `CalendarView.jsx` 抽出 `handleFitAnalysis` 邏輯
- 從 `RunAnalysisView.jsx`、`StrengthAnalysisView.jsx` 抽出 FIT 解析邏輯
- 提供 `parseFITFile(file)` 函數
- 🆕 新增：`src/services/import/csvParser.js`
- 從 `CalendarView.jsx` 抽出 `handleCSVUpload` 邏輯
- 提供 `parseCSVFile(file)` 函數
- 🔧 修改：`src/views/CalendarView.jsx`
- 移除 FIT/CSV 解析邏輯（目前使用 `parseAndUploadFIT`、`parseAndUploadCSV`）
- 改用 `fitParser.js`、`csvParser.js` 的函數
- 🔧 修改：`src/views/RunAnalysisView.jsx`
- 移除 `handleFitAnalysis` 函數
- 改用 `fitParser.js`
- 🔧 修改：`src/views/StrengthAnalysisView.jsx`
- 移除 `handleFitAnalysis` 函數
- 改用 `fitParser.js`

**預估影響面**

- 影響檔案數：5 個（新增 2 個 + 修改 3 個）
- 不影響資料結構和儲存方式
- **功能風險**：⭐⭐ (低)

**完成標準**

- `fitParser.js`、`csvParser.js` 已建立
- CalendarView、RunAnalysisView、StrengthAnalysisView 中不再包含檔案解析邏輯
- FIT 檔案匯入功能正常（Garmin/Strava 格式）
- CSV 檔案匯入功能正常
- 錯誤處理一致且可透過 `ErrorToast` 顯示

**自動化程度**

- **👤 需要人工確認**
- 建議：先將邏輯複製到新檔案，測試通過後再從 View 移除

---

#### 任務 2-2：驗證 AI JSON 解析統一使用

**目標**

- 確認所有 AI service 都使用 `utils/aiJson.js` 的 `parseLLMJson` 函數
- 移除各 AI service 中重複的 JSON 解析邏輯

**修改檔案**

- 🔧 檢查並修改：
- `src/services/ai/nutritionRecommendation.js`
- `src/services/ai/formCorrection.js`
- `src/components/AICoach/CoachChat.jsx`（若有結構化輸出）
- 其他會從 LLM 讀 JSON 的 services

**預估影響面**

- 影響檔案數：3–6 個 AI service
- 功能不變，但若 helper 寫錯會影響多處
- **功能風險**：⭐⭐ (低)

**完成標準**

- 所有 AI service 不再自行 `replace(/```json/g, '')` / `substring(startIndex, endIndex + 1)`
- 全域搜尋 `JSON.parse` 在 AI service 中的使用，確認都有使用 `parseLLMJson` 包裝
- 在 AI 回傳正常 JSON、包在 ```json 區塊、或有前後雜訊文案時都能成功 parse
- 當解析失敗時，會統一丟出可被 `handleError` 捕捉的錯誤（含 context）

**自動化程度**

- **👤 需要人工確認**
- 建議：使用 grep 搜尋 `JSON.parse` 和 `replace(/```json`，逐一檢查並替換

---

#### 任務 2-3：建立 MediaPipe 分析服務

**目標**

- 從 `StrengthAnalysisView.jsx`、`RunAnalysisView.jsx` 抽出 MediaPipe 姿態分析邏輯
- 抽出評分計算邏輯，讓 View 專注於 UI 互動

**修改檔案**

- 🆕 新增：`src/services/analysis/poseAnalysis.js`
- 封裝 MediaPipe 姿態分析邏輯
- 提供 `analyzePose(video)` 函數
- 🆕 新增：`src/services/analysis/metricsCalculator.js`
- 抽出評分計算邏輯
- 提供 `calculateFormScore(poseData)` 函數
- 🔧 修改：`src/views/StrengthAnalysisView.jsx`
- 改用 `poseAnalysis.js`、`metricsCalculator.js`
- 移除 MediaPipe 和評分計算邏輯
- 🔧 修改：`src/views/RunAnalysisView.jsx`
- 改用 `poseAnalysis.js`、`metricsCalculator.js`
- 移除 MediaPipe 和評分計算邏輯

**預估影響面**

- 影響檔案數：4 個（新增 2 個 + 修改 2 個）
- 不影響資料儲存，只移動邏輯
- **功能風險**：⭐⭐⭐ (中) - 複雜的姿態分析邏輯

**完成標準**

- `poseAnalysis.js`、`metricsCalculator.js` 已建立
- StrengthAnalysisView、RunAnalysisView 中不再包含 MediaPipe 邏輯
- 姿態偵測功能正常（重訓/跑步動作）
- 評分計算準確
- AI 分析建議正常
- 儲存功能正常

**自動化程度**

- **👤 需要人工確認**
- 建議：保留原始邏輯作為註解，對比抽離前後的結果

---

#### 任務 2-4：建立響應式 Hooks

**目標**

- 建立 `useWorkouts`、`useNutrition`、`useGears` 等 Hooks，封裝資料訂閱邏輯
- 建立 `workoutStore.js`，實現響應式資料流，資料變更時 UI 自動更新

**修改檔案**

- 🆕 新增：`src/hooks/useWorkouts.js`
- 封裝訓練資料訂閱，提供 `useWorkouts(dateRange)`
- 自動處理載入狀態和錯誤
- 🆕 新增：`src/hooks/useNutrition.js`
- 封裝營養紀錄訂閱，提供 `useNutrition(date)`
- 🆕 新增：`src/hooks/useGears.js`
- 封裝裝備管理，提供 `useGears()`
- 🆕 新增：`src/store/workoutStore.js`
- 訓練資料狀態（響應式）
- 提供 `useWorkoutStore()` Hook
- 🔧 修改：`src/views/DashboardView.jsx`
- 改用 `useWorkouts` Hook，移除手動 `fetchWorkoutStats`
- 🔧 修改：`src/views/CalendarView.jsx`
- 改用 `useWorkouts` Hook，移除手動 `fetchMonthWorkouts`

**預估影響面**

- 影響檔案數：約 5–6 個（新增 4 個 + 修改 2–3 個）
- 會改變資料更新機制，需確保訂閱正確取消
- **功能風險**：⭐⭐⭐ (中) - 狀態管理變更，可能導致 UI 不更新

**完成標準**

- `useWorkouts`、`useNutrition`、`useGears` Hooks 已建立
- `workoutStore.js` 已建立，可正常使用
- Dashboard、Calendar 等頁面改用新 Hooks
- 資料更新時 UI 自動刷新（不需要手動觸發）
- Calendar 更新後 Dashboard 自動刷新
- 組件卸載時正確取消訂閱（無記憶體洩漏）
- 多分頁同步正常

**自動化程度**

- **👤 需要人工確認**
- 建議：使用 React DevTools 檢查狀態更新，測試快速切換頁面

---

#### 任務 2-5：遷移至統一 API 層

**目標**

- 逐步將 `calendarService.js`、`nutritionService.js` 等改為使用 `api/*` 層
- 統一錯誤處理、快取策略，讓資料存取層更清晰

**修改檔案**

- 🔧 修改：`src/api/workouts.js` - 完善實作，與 `calendarService.js` 功能對應
- 🔧 修改：`src/api/nutrition.js` - 完善實作，與 `nutritionService.js` 功能對應
- 🔧 修改：`src/api/body.js` - 完善實作，與 `bodyService.js` 功能對應
- 🔧 修改：`src/services/calendarService.js`
- 改用 `api/workouts.js` 的函數（內部實作）
- 🔧 修改：`src/services/nutritionService.js`
- 改用 `api/nutrition.js` 的函數（內部實作）

**預估影響面**

- 影響檔案數：約 5–6 個（修改 API 層 + Services 層）
- 不影響 View 層，只改變 Service 內部實作
- **功能風險**：⭐⭐⭐ (中) - 資料庫操作，錯誤會導致資料遺失

**完成標準**

- `api/workouts.js`、`api/nutrition.js`、`api/body.js` 已完成實作
- Services 層改用 API 層的函數
- 讀取/新增/更新/刪除功能正常
- 實時訂閱正常（多分頁同步）
- 離線模式正常（快取讀取）
- 錯誤處理統一且一致

**自動化程度**

- **👤 需要人工確認**
- 建議：保留原 Firebase 調用作為備份註解，對比重構前後的資料查詢結果

---

### 🔧 階段三：大型 View 精簡與架構收斂

#### 任務 3-1：精簡 CalendarView.jsx（高風險）

**目標**

- 將 `CalendarView.jsx` 從 700+ 行降至 200-300 行
- 移除所有業務邏輯，只保留 UI 組合和事件處理

**修改檔案**

- 🆕 新增：`src/components/Calendar/WorkoutCard.jsx` - 訓練卡片元件（可重用）
- 🆕 新增：`src/components/Calendar/ImportSection.jsx` - 匯入相關 UI
- 🔧 修改：`src/views/CalendarView.jsx`
- 移除 FIT/CSV 解析邏輯（改用 `fitParser.js`、`csvParser.js`）
- 移除 AI 生成邏輯（改用 `workoutGenerator.js`）
- 移除日期/數值處理（改用 `utils/date.js`、`utils/number.js`）
- 移除 Firebase 直接呼叫（改用 `useWorkouts` Hook）
- 只保留：選擇日期區間、控制 modal 狀態、呼叫已完成的 service/hook

**預估影響面**

- 影響檔案數：3 個（新增 2 個 + 修改 1 個）
- 幾乎涵蓋所有主要頁面功能
- **功能風險**：⭐⭐⭐⭐ (高) - 大型組件修改，容易遺漏細節

**完成標準**

- CalendarView.jsx 行數降至 200-300 行
- 所有既有功能在重構後仍全部可用：
- 新增/編輯/刪除訓練紀錄
- 拖曳移動訓練到不同日期
- Ctrl+拖曳複製訓練
- AI 生成單日課表（重訓/跑步）
- AI 生成本週課表（多選模式）
- 匯入 FIT 檔案（Garmin/Strava）
- 匯入 CSV 檔案
- 匯出 CSV 備份
- 更新後 Dashboard 自動刷新
- 切換月份顯示正常
- 瀏覽器 console 無新增錯誤或警告

**自動化程度**

- **👤 不適合自動重構，強烈建議人工逐步重構 + 驗證**
- 建議：每次只處理一個功能區塊，完成後立即測試，使用 Git 分支管理

---

#### 任務 3-2：精簡 StrengthAnalysisView.jsx 與 RunAnalysisView.jsx

**目標**

- 將 `StrengthAnalysisView.jsx` 從 400+ 行降至 150-200 行
- 將 `RunAnalysisView.jsx` 從 600+ 行降至 150-200 行
- 移除所有業務邏輯，只保留 UI 組合

**修改檔案**

- 🔧 修改：`src/views/StrengthAnalysisView.jsx`
- 移除 MediaPipe 邏輯（改用 `poseAnalysis.js`）
- 移除評分計算（改用 `metricsCalculator.js`）
- 移除 AI 分析邏輯（改用 `analysisService.js`）
- 🔧 修改：`src/views/RunAnalysisView.jsx`
- 移除 MediaPipe 邏輯（改用 `poseAnalysis.js`）
- 移除評分計算（改用 `metricsCalculator.js`）
- 移除 AI 分析邏輯（改用 `analysisService.js`）

**預估影響面**

- 影響檔案數：2 個
- 不影響資料儲存，只改變 View 結構
- **功能風險**：⭐⭐⭐⭐ (高) - 複雜的姿態分析功能

**完成標準**

- StrengthAnalysisView.jsx 行數降至 150-200 行
- RunAnalysisView.jsx 行數降至 150-200 行
- 所有既有功能在重構後仍全部可用：
- 姿態偵測功能正常（重訓/跑步動作）
- 評分計算準確
- AI 分析建議正常
- 儲存功能正常
- 瀏覽器 console 無新增錯誤或警告

**自動化程度**

- **👤 不適合自動重構，強烈建議人工逐步重構 + 驗證**
- 建議：保留原始邏輯作為註解，逐功能測試

---

#### 任務 3-3：精簡 DashboardView.jsx

**目標**

- 將 `DashboardView.jsx` 從 500+ 行降至 200-250 行
- 移除手動資料載入，改用響應式 Hooks

**修改檔案**

- 🔧 修改：`src/views/DashboardView.jsx`
- 移除手動 `fetchWorkoutStats`（改用響應式 `useWorkouts`）
- 簡化狀態管理（改用 `workoutStore`）
- 移除重複的日期/數值處理邏輯

**預估影響面**

- 影響檔案數：1 個
- 不影響資料來源，只改變載入方式
- **功能風險**：⭐⭐⭐ (中)

**完成標準**

- DashboardView.jsx 行數降至 200-250 行
- 所有既有功能在重構後仍全部可用：
- 統計數據顯示正常
- 肌肉熱圖顯示正常
- 今日課表顯示正常
- PR 追蹤顯示正常
- 成就面板顯示正常
- 資料更新時 UI 自動刷新（不需要手動觸發）
- 瀏覽器 console 無新增錯誤或警告

**自動化程度**

- **👤 需要人工確認**
- 建議：逐步替換，測試每個功能區塊

---

#### 任務 3-4：統一命名與組織

**目標**

- 統一檔案命名規範和函數命名規範
- 整理 `services/` 目錄結構，移除根層服務檔案

**修改檔案**

- 🔧 整理：`src/services/` 目錄結構
- 將根層服務檔案移至對應子目錄（如 `config/apiKeyService.js`）
- 統一檔案命名（`.jsx` for components, `.js` for services/utils）
- 🔧 整理：函數命名規範
- 統一使用 camelCase，英文命名
- 統一註解格式

**預估影響面**

- 影響檔案數：所有服務檔案
- 只改變檔案位置和命名，不影響功能
- **功能風險**：⭐⭐ (低) - 主要是重構工作

**完成標準**

- 檔案命名規範統一（`.jsx` for components, `.js` for services/utils）
- 函數命名規範統一（camelCase，英文命名）
- `services/` 目錄結構清晰，根層不再有散落的服務檔案
- 所有 import 路徑已更新，功能正常
- 專案結構清晰，易於導航

**自動化程度**

- **🤖 部分可自動重構**
- 建議：使用 VS Code 的重構工具批量更新 import 路徑

---

## 📦 使用者本地硬碟瘦身（已完成）

**背景**：App 為 PWA，且涉及大量影像處理（食物照片辨識、動作分析影片）。針對**使用者本機硬碟**（瀏覽器 Blob、記憶體、Cache 等）瘦身，避免不必要的佔用。**Firebase 容量不納入**，僅處理本機儲存。

### 已實作項目

| 項目 | 說明 | 修改檔案 |
|------|------|----------|
| **影片 Blob 回收** | 動作分析影片使用 `URL.createObjectURL` 後，於清除、換檔、FIT 模式、**卸載頁面**時一律 `URL.revokeObjectURL`，釋放本機記憶體／Blob。 | `StrengthAnalysisView.jsx`、`RunAnalysisView.jsx` |
| **CSV 匯出 Blob 回收** | 行事曆匯出、趨勢匯出之 CSV 下載完成後立即 `revokeObjectURL`。 | `CalendarView.jsx`、`TrendAnalysisView.jsx` |

### 既有狀態（無須變更）

- **Service Worker**（`public/sw.js`）：僅快取 `manifest.json`，不快取 JS/CSS/ 靜態圖；導航與 API 不攔截。已精簡。
- **calendarService 快取**：in-memory `Map`，不寫入本機。
- **食物照片**：僅送 Gemini 辨識，不存本機；`food_logs` 只存營養數字。
- **body_logs**：僅 `date` / `weight` / `bodyFat`，無圖片。
- **localStorage**：僅 API Key、備份摘要等小量資料。

---

## 🎨 UI / 美術設計優化（可選）

### Style 1：Modern Fitness Dark（現代健身深色儀表板）

**目標**

- 打造以「深色為主、強調數據可讀性」的健身儀表板風格

**修改檔案**

- `tailwind.config.js` - 定義色系
- `src/index.css` / `src/App.css` - 設定全域背景和字體
- `src/components/Dashboard/StatCard.jsx`
- `src/views/DashboardView.jsx`
- `src/views/TrainingDashboardView.jsx`

**預估影響面**

- 以「外觀」為主，不改資料流與邏輯，**功能風險低**

---

### Style 2：Glassmorphism AI Panel（AI 教練磨砂玻璃風）

**目標**

- 針對 AI 教練與右下角聊天視窗，採用 Glassmorphism 風格

**修改檔案**

- `src/components/AICoach/CoachChat.jsx`
- `src/layouts/MainLayout.jsx`
- `src/index.css` - 加上 glass 卡片的通用 class

**預估影響面**

- 僅影響 AI 聊天相關 UI 與局部 layout，**功能風險極低**

---

### Style 3：Bento Grid Dashboard（便當盒式模組化卡片）

**目標**

- 將 Dashboard 的各類資訊重新排版成具「Bento Grid」感的模組化卡片

**修改檔案**

- `src/views/DashboardView.jsx`
- `src/components/Dashboard/StatCard.jsx`
- `src/components/Dashboard/AchievementPanel.jsx`
- `src/components/Dashboard/PRTracker.jsx`

**預估影響面**

- 僅改排版與卡片尺寸，不修改資料來源與邏輯，**中低風險**

---

### Style 4：Minimal Health OS（極簡健康作業系統風）

**目標**

- 將 Profile、Nutrition、Calendar 等頁面，往「Health OS / Apple Fitness」那種極簡風格靠攏

**修改檔案**

- `src/views/Profile` 下各子元件
- `src/views/NutritionView.jsx`
- `src/views/CalendarView.jsx`
- `src/layouts/MainLayout.jsx`

**預估影響面**

- 對使用者體感改變較大，但大多是 CSS 級別調整，**功能風險低**

---

## 📅 建議執行順序

### 第一優先（階段二核心任務）

1. **任務 2-1：抽離檔案解析服務**（2-3 天）

- 降低 CalendarView 複雜度，為後續精簡鋪路

2. **任務 2-4：建立響應式 Hooks**（3-4 天）

- 為 View 精簡奠定基礎，實現自動資料同步

3. **任務 2-3：建立 MediaPipe 分析服務**（2-3 天）

- 為分析 View 精簡做準備

### 第二優先（階段三 View 精簡）

4. **任務 3-1：精簡 CalendarView.jsx**（3-4 天）

- 最大型的 View，需要謹慎處理

5. **任務 3-2：精簡分析 View**（2-3 天）

- 依賴任務 2-3 完成

6. **任務 3-3：精簡 DashboardView.jsx**（2-3 天）

- 依賴任務 2-4 完成

### 第三優先（完善與優化）

7. **任務 2-2：驗證 AI JSON 解析統一**（1 天）

- 確保所有 AI 服務使用統一解析

8. **任務 2-5：遷移至統一 API 層**（2-3 天）

- 完善 API 層實作

9. **任務 3-4：統一命名與組織**（1-2 天）

- 整理專案結構

10. **UI 優化**（可選，視時間決定）

- 建議順序：Style 1 → Style 2 → Style 3 → Style 4

---

## ⚠️ 注意事項

1. **測試覆蓋**

- 每次重構後應進行完整的功能測試
- 特別注意 AI 功能、資料同步、錯誤處理

2. **向後相容**

- API 層目前作為轉接層，確保現有功能不受影響
- 逐步遷移，避免大規模一次性變更

3. **文件更新**

- 隨著服務層的建立，應更新相關文件
- 記錄服務的職責和使用方式

4. **Git 策略**

- 每個任務建立獨立 commit
- 使用 Git 分支管理大型重構
- 保留原始邏輯作為備份註解

---

## 📊 預估時間表

- **階段二剩餘工作**：8-12 天
- 任務 2-1：2-3 天
- 任務 2-2：1 天
- 任務 2-3：2-3 天
- 任務 2-4：3-4 天
- 任務 2-5：2-3 天（可與其他任務並行）

- **階段三工作**：7-10 天
- 任務 3-1：3-4 天
- 任務 3-2：2-3 天
- 任務 3-3：2-3 天
- 任務 3-4：1-2 天

- **UI 優化**：可視時間和需求決定優先順序

**總計**：約 3-4 週可完成主要重構工作