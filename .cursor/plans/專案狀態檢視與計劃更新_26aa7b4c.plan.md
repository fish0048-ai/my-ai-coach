---
name: "專案狀態檢視與計劃更新"
overview: "重構與 Agentic RAG 中長期藍圖整合計劃。階段二/三業務邏輯抽離、View 精簡；3D 虛擬城市為最低優先。"
todos:
  - id: rag-p1-1
    content: "Agentic RAG Phase 1：資料庫選型（PostgreSQL + pgvector）"
    status: pending
  - id: rag-p1-2
    content: "Agentic RAG Phase 1：資料清洗 ETL"
    status: pending
  - id: rag-p1-3
    content: "Agentic RAG Phase 1：開發統計 API calculate_stats"
    status: pending
  - id: rag-p2-1
    content: "Agentic RAG Phase 2：定義 Tool Schema"
    status: pending
  - id: rag-p2-2
    content: "Agentic RAG Phase 2：Prompt Engineering"
    status: pending
  - id: rag-p2-3
    content: "Agentic RAG Phase 2：串接 OpenAI/Gemini API"
    status: pending
  - id: rag-p3-1
    content: "Agentic RAG Phase 3：Embedding Pipeline"
    status: pending
  - id: rag-p3-2
    content: "Agentic RAG Phase 3：檢索邏輯（關鍵字觸發向量搜尋）"
    status: pending
  - id: rag-p3-3
    content: "Agentic RAG Phase 3：歷史對話壓縮（摘要機制）"
    status: pending
isProject: false
---

# 專案狀態檢視與計劃更新

> **最後更新時間**：2025-01-26
> **專案狀態**：🟡 重構進行中
> **註**：3D 虛擬城市（World DSL）優先度最低，本計劃暫不處理。

## 🏙 3D 虛擬城市世界腳本（World DSL）

以下區塊以資料驅動的方式描述「小人走進不同房子就啟動對應功能」，以及功能之間的同步關係。未來若要做類遊戲化 UI，可以直接讀取此腳本產生世界場景。

```world
avatar:
  id: player
  startRoom: calendar.lobby

buildings:
  - id: calendar
    name: 行事曆館
    rooms:
      - id: lobby
        label: 月曆大廳
        onEnter:
          - action: navigate
            targetView: CalendarView
            description: 顯示行事曆與每日訓練課表
      - id: import_corner
        label: 匯入角落
        onEnter:
          - action: openModal
            target: calendarImportModal
            description: 上傳 FIT / CSV 檔案並匯入訓練紀錄
      - id: weekly_coach_desk
        label: 週教練桌
        onEnter:
          - action: callService
            service: generateWeeklyWorkout
            description: 由 AI 總教練產生本週訓練課表
      - id: sync_console
        label: 同步控制台
        onEnter:
          - action: callService
            service: platformSync
            description: 與 Garmin / Strava 等外部平台同步

  - id: dashboard
    name: 訓練儀表板
    rooms:
      - id: overview
        label: 30 天訓練總覽
        onEnter:
          - action: navigate
            targetView: DashboardView
            description: 顯示近 30 天訓練統計、PR 與肌群熱圖

  - id: nutrition
    name: 營養研究所
    rooms:
      - id: today_logs
        label: 今日飲食紀錄
        onEnter:
          - action: navigate
            targetView: NutritionView
            description: 檢視與編輯今日食物與營養素
      - id: ai_nutrition_lab
        label: 智能營養實驗室
        onEnter:
          - action: callService
            service: generateNutritionRecommendation
            description: 根據訓練與缺口產生營養建議

  - id: ai_coach
    name: AI 教練中心
    rooms:
      - id: lobby
        label: 教練諮詢櫃台
        onEnter:
          - action: openPanel
            target: CoachChat
            description: 開啟 AI 教練聊天視窗
      - id: settings
        label: 設定室
        onEnter:
          - action: openPanel
            target: CoachChatSettings
            description: 設定 API Key、同步 AI Context 與個人知識庫

  - id: knowledge_base
    name: 個人知識庫圖書館
    rooms:
      - id: shelf_overview
        label: 紀錄書架
        onEnter:
          - action: navigate
            targetView: KnowledgeBaseView
            description: 檢視與管理個人知識庫紀錄

  - id: trend
    name: 趨勢分析塔
    rooms:
      - id: trends
        label: 長期趨勢觀測室
        onEnter:
          - action: navigate
            targetView: TrendAnalysisView
            description: 顯示訓練與體重趨勢、訓練周期分析

links:
  # 行事曆 → 儀表板：訓練歷史同步
  - from: calendar.lobby
    to: dashboard.overview
    sync:
      type: workouts_history
      direction: calendar->dashboard
      triggers: [workoutCompleted, importFinished]
      visual:
        idle: dim_line          # 平時為微亮線條
        active: pulsing_beam    # 有新訓練或匯入時，出現脈衝光束

  # 行事曆 → 趨勢分析塔：趨勢資料同步
  - from: calendar.lobby
    to: trend.trends
    sync:
      type: workouts_history
      direction: calendar->trend
      triggers: [workoutCompleted, importFinished]
      visual:
        active: flowing_particles  # 粒子順著塔間管線流動

  # 行事曆 → AI 教練：AI Context 更新
  - from: calendar.lobby
    to: ai_coach.lobby
    sync:
      type: ai_context
      direction: calendar->ai_coach
      triggers: [workoutCompleted, contextUpdated]
      visual:
        active: floating_orbs   # 小光球從行事曆館飛向教練中心

  # 營養 → 個人知識庫：飲食紀錄入庫
  - from: nutrition.today_logs
    to: knowledge_base.shelf_overview
    sync:
      type: nutrition_logs
      direction: nutrition->knowledge_base
      triggers: [foodLogCreated]
      visual:
        active: papers_flying   # 紙張從營養研究所飛到圖書館書架

  # 個人知識庫 → AI 教練：RAG 知識支援
  - from: knowledge_base.shelf_overview
    to: ai_coach.lobby
    sync:
      type: rag_context
      direction: knowledge_base->ai_coach
      triggers: [coachQuery]
      visual:
        active: pages_glowing   # 書頁發光後飄向教練中心
```

> 註：`buildings` / `rooms` / `links` 僅為世界腳本描述，實際 React/Vite 實作仍以下方原始技術規劃為準；未來若要做 3D / 類遊戲化 UI，可由前端解析上述 `world` 區塊自動生成場景。

## 📊 專案整體進度

### ✅ 已完成項目

1. **工具庫統一** - `utils/date.js`、`utils/number.js`、`utils/aiJson.js` 已建立並使用
2. **API Key 管理遷移** - `apiKeyService.js` 和 `useApiKey.js` 已建立，所有直接使用 localStorage 的地方已遷移
3. **AI 服務層建立** - `workoutGenerator.js`、`coachService.js`、`analysisService.js` 已建立
4. **API 層骨架** - `api/workouts.js`、`api/nutrition.js`、`api/body.js`、`api/gears.js` 已建立
5. **PR 服務抽離** - `services/workout/prService.js` 已建立
6. **使用者本地硬碟瘦身** - 影片 / CSV Blob URL 即時回收，減輕本機記憶體與磁碟負擔（見下方章節；Firebase 容量不納入）
7. **任務 2-1：抽離檔案解析服務** - `fitParser.js`、`csvParser.js` 已存在；CalendarView 移除未使用 FitParser、改從 `importService` 匯入；Run/Strength 分析 View 已使用 `fitParser.extractFITMetrics`
8. **任務 2-2：驗證 AI JSON 解析統一使用** - workoutGenerator、formCorrection、nutritionRecommendation、NutritionView 均使用 `parseLLMJson`（2025-01-26）
9. **任務 2-3：建立 MediaPipe 分析服務** - `poseAnalysis.js`、`metricsCalculator.js` 已建立；Strength/Run 分析 View 已改用（2025-01-26）
10. **任務 2-4：建立響應式 Hooks** - `useWorkouts`、`useNutrition`、`useGears`、`workoutStore` 已建立；Calendar、Dashboard、Nutrition、Gear View 已使用（2025-01-26）
11. **任務 3-1（部分）：精簡 CalendarView** - 新增 `WorkoutCard.jsx`、`ImportSection.jsx`（2025-01-26）
12. **任務 3-4（部分）：統一命名與組織** - `apiKeyService` 已移至 `services/config/`（2025-01-26）

---

## 🎯 中長期架構藍圖（Agentic RAG）

> 本節內容為 Agentic RAG 架構藍圖，屬中長期技術方向。現有 Phase 2/3 重構仍以既有 Firestore + React 架構為主；本藍圖可作為未來導入後端、向量資料庫、Function Calling 時的參考依據。

### 結論

你的系統架構應採用 **「Agentic RAG（代理式檢索增強生成）」** 模式。
核心不在於讓 LLM 記住所有事，而是讓 LLM **「擁有查詢資料庫的工具」**。這能將 Token 消耗降低 **90%** 以上，並將回應延遲控制在 **3~5 秒** 內。

---

### 一、系統架構說明 (System Architecture)

這個架構分為三層，確保數據流動的高效與準確：

#### 1. 應用層 (Frontend & API Gateway)

- **介面：** 使用者網頁（React/Vue）。
- **功能：** 接收使用者自然語言問題，轉發給後端。
- **關鍵指標：** API 回應時間 (Latency) 目標 **< 200 ms** (不含 LLM 生成時間)。

#### 2. 邏輯編排層 (Orchestration Layer - The Brain)

這是核心，你的 Backend (Python/FastAPI) 與 LLM 互動的地方。

- **Router (意圖判斷)：** 判斷使用者是在「閒聊」還是在「查數據」。
- **Function Caller (工具人)：**
  - 若問「我上週跑量？」，LLM 生成 SQL 查詢參數：`{start: "2025-01-27", end: "2025-02-02", metric: "distance"}`。
  - 若問「為何我膝蓋痛？」，LLM 生成向量搜尋關鍵字：`"膝蓋痛", "受傷"`。
- **Context Assembler (組裝工)：** 將資料庫撈回來的「統計數字」與「筆記片段」組裝成最終 Prompt。
- **關鍵指標：** 傳送給 LLM 的 Context Window 控制在 **4,000 Tokens** 以內。

#### 3. 資料儲存層 (Data Layer - The Memory)

- **關聯式資料庫 (SQL DB)：** 存儲結構化數據（日期、配速 `5:30 min/km`、心率 `145 bpm`）。
- **向量資料庫 (Vector DB)：** 存儲非結構化數據（心得、日記）。需將文字轉為 **1536 維** (OpenAI 規格) 的向量。
- **關鍵指標：** 向量檢索準確度 (Recall) 目標 **> 85%**。

---

### 二、短中長期目標 (Goals)

#### 短期目標：建立數據管道 (1~2 個月)

- **目標：** 讓 LLM 能看懂你的運動數據，回答基礎事實問題。
- **功能：**
  1. 資料庫建置完成，並寫好計算統計值（週跑量、月均速）的 API。
  2. 實作 LLM **Function Calling**，讓它能準確調用上述 API。
  3. 能回答：「我上個月總共跑了幾公里？」、「我昨天的平均心率是多少？」。
- **驗收標準：** Function Calling 成功率 **> 95%**，不會胡亂生成 SQL。

#### 中期目標：導入 RAG 與記憶 (3~4 個月)

- **目標：** 解決「失憶」問題，並結合質化感受（心得）進行分析。
- **功能：**
  1. 加入 **Vector DB (如 pgvector)**，將歷史日記向量化。
  2. 實作 **Hybrid Search**：同時查詢數據（SQL）與心得（Vector）。
  3. 能回答：「依照我上次膝蓋痛的經驗，這週該怎麼調整課表？」（結合數據下降趨勢 + 歷史傷痛紀錄）。
- **驗收標準：** 檢索出的歷史日記相關性分數 (Cosine Similarity) **> 0.75**。

#### 長期目標：主動式教練 (6 個月+)

- **目標：** 從「被動問答」轉為「主動建議」。
- **功能：**
  1. **每日排程 (Cron Job)：** 系統每天早上自動跑一次分析，若發現數據異常（如心率變異度 HRV 下降 **10%**），主動發送建議給使用者。
  2. **長期趨勢預測：** 根據過去 **6 個月** 的數據，預測未來比賽成績。
- **驗收標準：** 使用者對建議的採納率 **> 80%**。

---

### 三、To-Do List (執行清單)

#### Phase 1: 資料庫與 API 基礎 (Data Foundation)

1. [ ] **資料庫選型：** 建議使用 **PostgreSQL**。安裝 `**pgvector**` 插件，這樣同一個 DB 可以同時存 SQL 數據和 Vector 數據，省維護成本。
2. [ ] **資料清洗 (ETL)：** 寫 Script 將你的歷史數據匯入。
  - 數值欄位：確保單位統一（距離統一用 **meter**，時間統一用 **second**）。
  - 文字欄位：將日記內容清洗，去除 HTML 標籤。
3. [ ] **開發統計 API：** 寫一支 Python Function `calculate_stats(start_date, end_date, field)`。
  - 測試輸入：查詢過去 **7 天** 的平均心率。
  - 預期輸出：回傳單一浮點數（如 `152.5`）。

#### Phase 2: LLM 整合 (LLM Integration)

1. [ ] **定義 Tool Schema：** 撰寫 JSON Schema 描述你的統計 API，包含欄位說明（e.g., "unit: meters"）。
2. [ ] **Prompt Engineering：** 設計系統提示詞 (System Prompt)。
  - 內容包含：「你是一個專業跑步教練，請依照提供的數據回答，不要憑空捏造。配速請自動換算為 **min/km** 格式。」
3. [ ] **串接 OpenAI/Gemini API：** 實作 Chat 介面，測試 LLM 能否在對話中自動觸發 API 抓資料。

#### Phase 3: 記憶與向量 (RAG & Memory)

1. [ ] **Embedding Pipeline：** 寫 Script 呼叫 Embedding API (如 OpenAI text-embedding-3-small)，將所有歷史日記轉成 **1536 維** 向量並存入 DB。
2. [ ] **檢索邏輯：** 當使用者問題包含「感覺」、「痛」、「心情」等關鍵字時，觸發向量搜尋。
3. [ ] **歷史對話壓縮：** 實作「摘要機制」，每 **5 輪** 對話將前文壓縮成 **50~100 字** 的摘要存入 Prompt。

---

### 自我驗證 (Self-Verification)

- **架構完整性：** 涵蓋前端、後端邏輯、SQL/Vector 混合資料庫，符合現代 AI 應用標準。
- **內容具體性：** 提供了具體的技術選型（PostgreSQL, pgvector）、維度（1536）、延遲目標（200ms）、Token 限制（4000）。
- **語言：** 全程使用繁體中文。
- **解決痛點：** 明確指出利用「Function Calling」與「Database」來解決 LLM 長期對話失憶與計算能力不足的問題。

**可信度評分：98/100**

---

## 📋 待完成任務清單

### 🔧 階段二：業務邏輯抽離與服務層建立

#### ~~任務 2-1：抽離檔案解析服務~~（已完成）

**目標**

- 從 `CalendarView.jsx` 抽出 FIT/CSV 檔案解析邏輯至獨立服務
- 讓 View 專注於 UI 互動，檔案處理邏輯集中管理

**修改檔案**

- 🆕 新增：`src/services/import/fitParser.js`
- 從 `CalendarView.jsx` 抽出 `handleFitAnalysis` 邏輯
- 從 `RunAnalysisView.jsx`、`StrengthAnalysisView.jsx` 抽出 FIT 解析邏輯
- 提供 `parseFITFile(file)` 函數
- 🆕 新增：`src/services/import/csvParser.js`
- 從 `CalendarView.jsx` 抽出 `handleCSVUpload` 邏輯
- 提供 `parseCSVFile(file)` 函數
- 🔧 修改：`src/views/CalendarView.jsx`
- 移除 FIT/CSV 解析邏輯（目前使用 `parseAndUploadFIT`、`parseAndUploadCSV`）
- 改用 `fitParser.js`、`csvParser.js` 的函數
- 🔧 修改：`src/views/RunAnalysisView.jsx`
- 移除 `handleFitAnalysis` 函數
- 改用 `fitParser.js`
- 🔧 修改：`src/views/StrengthAnalysisView.jsx`
- 移除 `handleFitAnalysis` 函數
- 改用 `fitParser.js`

**預估影響面**

- 影響檔案數：5 個（新增 2 個 + 修改 3 個）
- 不影響資料結構和儲存方式
- **功能風險**：⭐⭐ (低)

**完成標準**

- `fitParser.js`、`csvParser.js` 已建立
- CalendarView、RunAnalysisView、StrengthAnalysisView 中不再包含檔案解析邏輯
- FIT 檔案匯入功能正常（Garmin/Strava 格式）
- CSV 檔案匯入功能正常
- 錯誤處理一致且可透過 `ErrorToast` 顯示

**自動化程度**

- **👤 需要人工確認**
- 建議：先將邏輯複製到新檔案，測試通過後再從 View 移除

---

#### ~~任務 2-2：驗證 AI JSON 解析統一使用~~（已完成）

> **完成說明**：workoutGenerator、formCorrection、nutritionRecommendation、NutritionView 均已使用 `parseLLMJson`；CoachChat 無需解析 JSON（純文字回覆）；backupService 解析備份檔非 LLM 輸出。已完成 2025-01-26。

**目標**

- 確認所有 AI service 都使用 `utils/aiJson.js` 的 `parseLLMJson` 函數
- 移除各 AI service 中重複的 JSON 解析邏輯

**修改檔案**

- 🔧 檢查並修改：
- `src/services/ai/nutritionRecommendation.js`
- `src/services/ai/formCorrection.js`
- `src/components/AICoach/CoachChat.jsx`（若有結構化輸出）
- 其他會從 LLM 讀 JSON 的 services

**預估影響面**

- 影響檔案數：3–6 個 AI service
- 功能不變，但若 helper 寫錯會影響多處
- **功能風險**：⭐⭐ (低)

**完成標準**

- 所有 AI service 不再自行 `replace(/```json/g, '')` / `substring(startIndex, endIndex + 1)`
- 全域搜尋 `JSON.parse` 在 AI service 中的使用，確認都有使用 `parseLLMJson` 包裝
- 在 AI 回傳正常 JSON、包在 ```json 區塊、或有前後雜訊文案時都能成功 parse
- 當解析失敗時，會統一丟出可被 `handleError` 捕捉的錯誤（含 context）

**自動化程度**

- **👤 需要人工確認**
- 建議：使用 grep 搜尋 `JSON.parse` 和 `replace(/```json`，逐一檢查並替換

---

#### ~~任務 2-3：建立 MediaPipe 分析服務~~（已完成）

> **完成說明**：`poseAnalysis.js`、`metricsCalculator.js` 已存在；StrengthAnalysisView、RunAnalysisView 已 import 並使用 `analyzePoseAngle`、`processRunScanData`、`calculateStrengthScore`、`calculateRunScore` 等。已完成 2025-01-26。

**目標**

- 從 `StrengthAnalysisView.jsx`、`RunAnalysisView.jsx` 抽出 MediaPipe 姿態分析邏輯
- 抽出評分計算邏輯，讓 View 專注於 UI 互動

**修改檔案**

- 🆕 新增：`src/services/analysis/poseAnalysis.js`
- 封裝 MediaPipe 姿態分析邏輯
- 提供 `analyzePose(video)` 函數
- 🆕 新增：`src/services/analysis/metricsCalculator.js`
- 抽出評分計算邏輯
- 提供 `calculateFormScore(poseData)` 函數
- 🔧 修改：`src/views/StrengthAnalysisView.jsx`
- 改用 `poseAnalysis.js`、`metricsCalculator.js`
- 移除 MediaPipe 和評分計算邏輯
- 🔧 修改：`src/views/RunAnalysisView.jsx`
- 改用 `poseAnalysis.js`、`metricsCalculator.js`
- 移除 MediaPipe 和評分計算邏輯

**預估影響面**

- 影響檔案數：4 個（新增 2 個 + 修改 2 個）
- 不影響資料儲存，只移動邏輯
- **功能風險**：⭐⭐⭐ (中) - 複雜的姿態分析邏輯

**完成標準**

- `poseAnalysis.js`、`metricsCalculator.js` 已建立
- StrengthAnalysisView、RunAnalysisView 中不再包含 MediaPipe 邏輯
- 姿態偵測功能正常（重訓/跑步動作）
- 評分計算準確
- AI 分析建議正常
- 儲存功能正常

**自動化程度**

- **👤 需要人工確認**
- 建議：保留原始邏輯作為註解，對比抽離前後的結果

---

#### ~~任務 2-4：建立響應式 Hooks~~（已完成）

> **完成說明**：`useWorkouts`、`useNutrition`、`useGears`、`workoutStore.js` 已建立；CalendarView 使用 useWorkoutStore + useGears；DashboardView 使用 useTodayWorkouts + useWorkoutStore；NutritionView、GearView 已使用對應 Hooks。已完成 2025-01-26。

**目標**

- 建立 `useWorkouts`、`useNutrition`、`useGears` 等 Hooks，封裝資料訂閱邏輯
- 建立 `workoutStore.js`，實現響應式資料流，資料變更時 UI 自動更新

**修改檔案**

- 🆕 新增：`src/hooks/useWorkouts.js`
- 封裝訓練資料訂閱，提供 `useWorkouts(dateRange)`
- 自動處理載入狀態和錯誤
- 🆕 新增：`src/hooks/useNutrition.js`
- 封裝營養紀錄訂閱，提供 `useNutrition(date)`
- 🆕 新增：`src/hooks/useGears.js`
- 封裝裝備管理，提供 `useGears()`
- 🆕 新增：`src/store/workoutStore.js`
- 訓練資料狀態（響應式）
- 提供 `useWorkoutStore()` Hook
- 🔧 修改：`src/views/DashboardView.jsx`
- 改用 `useWorkouts` Hook，移除手動 `fetchWorkoutStats`
- 🔧 修改：`src/views/CalendarView.jsx`
- 改用 `useWorkouts` Hook，移除手動 `fetchMonthWorkouts`

**預估影響面**

- 影響檔案數：約 5–6 個（新增 4 個 + 修改 2–3 個）
- 會改變資料更新機制，需確保訂閱正確取消
- **功能風險**：⭐⭐⭐ (中) - 狀態管理變更，可能導致 UI 不更新

**完成標準**

- `useWorkouts`、`useNutrition`、`useGears` Hooks 已建立
- `workoutStore.js` 已建立，可正常使用
- Dashboard、Calendar 等頁面改用新 Hooks
- 資料更新時 UI 自動刷新（不需要手動觸發）
- Calendar 更新後 Dashboard 自動刷新
- 組件卸載時正確取消訂閱（無記憶體洩漏）
- 多分頁同步正常

**自動化程度**

- **👤 需要人工確認**
- 建議：使用 React DevTools 檢查狀態更新，測試快速切換頁面

---

#### 任務 2-5：遷移至統一 API 層（部分完成）

> **目前狀態**：`api/workouts.js`、`api/nutrition.js`、`api/body.js`、`api/gears.js` 已建立並作為轉接層包裝對應 service；workoutGenerator、useWorkouts、useNutrition 等已透過 API 層存取。完整遷移（Firebase 邏輯移入 api、service 僅呼叫 api）待後續執行。

**目標**

- 逐步將 `calendarService.js`、`nutritionService.js` 等改為使用 `api/*` 層
- 統一錯誤處理、快取策略，讓資料存取層更清晰

**修改檔案**

- 🔧 修改：`src/api/workouts.js` - 完善實作，與 `calendarService.js` 功能對應
- 🔧 修改：`src/api/nutrition.js` - 完善實作，與 `nutritionService.js` 功能對應
- 🔧 修改：`src/api/body.js` - 完善實作，與 `bodyService.js` 功能對應
- 🔧 修改：`src/services/calendarService.js`
- 改用 `api/workouts.js` 的函數（內部實作）
- 🔧 修改：`src/services/nutritionService.js`
- 改用 `api/nutrition.js` 的函數（內部實作）

**預估影響面**

- 影響檔案數：約 5–6 個（修改 API 層 + Services 層）
- 不影響 View 層，只改變 Service 內部實作
- **功能風險**：⭐⭐⭐ (中) - 資料庫操作，錯誤會導致資料遺失

**完成標準**

- `api/workouts.js`、`api/nutrition.js`、`api/body.js` 已完成實作
- Services 層改用 API 層的函數
- 讀取/新增/更新/刪除功能正常
- 實時訂閱正常（多分頁同步）
- 離線模式正常（快取讀取）
- 錯誤處理統一且一致

**自動化程度**

- **👤 需要人工確認**
- 建議：保留原 Firebase 調用作為備份註解，對比重構前後的資料查詢結果

---

### 🔧 階段三：大型 View 精簡與架構收斂

#### 任務 3-1：精簡 CalendarView.jsx（進行中）

> **目前狀態**：已新增 `WorkoutCard.jsx`、`ImportSection.jsx`；CalendarView 改用兩者，減少約 80 行。目標 200-300 行尚未達成，後續可繼續抽離 modal 區塊或表單相關邏輯。已完成 2025-01-26。

**目標**

- 將 `CalendarView.jsx` 從 700+ 行降至 200-300 行
- 移除所有業務邏輯，只保留 UI 組合和事件處理

**修改檔案**

- 🆕 新增：`src/components/Calendar/WorkoutCard.jsx` - 訓練卡片元件（可重用）
- 🆕 新增：`src/components/Calendar/ImportSection.jsx` - 匯入相關 UI
- 🔧 修改：`src/views/CalendarView.jsx`
- 移除 FIT/CSV 解析邏輯（改用 `fitParser.js`、`csvParser.js`）
- 移除 AI 生成邏輯（改用 `workoutGenerator.js`）
- 移除日期/數值處理（改用 `utils/date.js`、`utils/number.js`）
- 移除 Firebase 直接呼叫（改用 `useWorkouts` Hook）
- 只保留：選擇日期區間、控制 modal 狀態、呼叫已完成的 service/hook

**預估影響面**

- 影響檔案數：3 個（新增 2 個 + 修改 1 個）
- 幾乎涵蓋所有主要頁面功能
- **功能風險**：⭐⭐⭐⭐ (高) - 大型組件修改，容易遺漏細節

**完成標準**

- CalendarView.jsx 行數降至 200-300 行
- 所有既有功能在重構後仍全部可用：
- 新增/編輯/刪除訓練紀錄
- 拖曳移動訓練到不同日期
- Ctrl+拖曳複製訓練
- AI 生成單日課表（重訓/跑步）
- AI 生成本週課表（多選模式）
- 匯入 FIT 檔案（Garmin/Strava）
- 匯入 CSV 檔案
- 匯出 CSV 備份
- 更新後 Dashboard 自動刷新
- 切換月份顯示正常
- 瀏覽器 console 無新增錯誤或警告

**自動化程度**

- **👤 不適合自動重構，強烈建議人工逐步重構 + 驗證**
- 建議：每次只處理一個功能區塊，完成後立即測試，使用 Git 分支管理

---

#### 任務 3-2：精簡 StrengthAnalysisView.jsx 與 RunAnalysisView.jsx

**目標**

- 將 `StrengthAnalysisView.jsx` 從 400+ 行降至 150-200 行
- 將 `RunAnalysisView.jsx` 從 600+ 行降至 150-200 行
- 移除所有業務邏輯，只保留 UI 組合

**修改檔案**

- 🔧 修改：`src/views/StrengthAnalysisView.jsx`
- 移除 MediaPipe 邏輯（改用 `poseAnalysis.js`）
- 移除評分計算（改用 `metricsCalculator.js`）
- 移除 AI 分析邏輯（改用 `analysisService.js`）
- 🔧 修改：`src/views/RunAnalysisView.jsx`
- 移除 MediaPipe 邏輯（改用 `poseAnalysis.js`）
- 移除評分計算（改用 `metricsCalculator.js`）
- 移除 AI 分析邏輯（改用 `analysisService.js`）

**預估影響面**

- 影響檔案數：2 個
- 不影響資料儲存，只改變 View 結構
- **功能風險**：⭐⭐⭐⭐ (高) - 複雜的姿態分析功能

**完成標準**

- StrengthAnalysisView.jsx 行數降至 150-200 行
- RunAnalysisView.jsx 行數降至 150-200 行
- 所有既有功能在重構後仍全部可用：
- 姿態偵測功能正常（重訓/跑步動作）
- 評分計算準確
- AI 分析建議正常
- 儲存功能正常
- 瀏覽器 console 無新增錯誤或警告

**自動化程度**

- **👤 不適合自動重構，強烈建議人工逐步重構 + 驗證**
- 建議：保留原始邏輯作為註解，逐功能測試

---

#### 任務 3-3：精簡 DashboardView.jsx（部分完成）

> **目前狀態**：已改用 `useTodayWorkouts`、`useWorkoutStore`；統計計算已遷至 `workoutService.getDashboardStats`。行數精簡（降至 200-250 行）待後續執行。

**目標**

- 將 `DashboardView.jsx` 從 500+ 行降至 200-250 行
- 移除手動資料載入，改用響應式 Hooks

**修改檔案**

- 🔧 修改：`src/views/DashboardView.jsx`
- 移除手動 `fetchWorkoutStats`（改用響應式 `useWorkouts`）
- 簡化狀態管理（改用 `workoutStore`）
- 移除重複的日期/數值處理邏輯

**預估影響面**

- 影響檔案數：1 個
- 不影響資料來源，只改變載入方式
- **功能風險**：⭐⭐⭐ (中)

**完成標準**

- DashboardView.jsx 行數降至 200-250 行
- 所有既有功能在重構後仍全部可用：
- 統計數據顯示正常
- 肌肉熱圖顯示正常
- 今日課表顯示正常
- PR 追蹤顯示正常
- 成就面板顯示正常
- 資料更新時 UI 自動刷新（不需要手動觸發）
- 瀏覽器 console 無新增錯誤或警告

**自動化程度**

- **👤 需要人工確認**
- 建議：逐步替換，測試每個功能區塊

---

#### 任務 3-4：統一命名與組織（部分完成）

> **目前狀態**：已將 `apiKeyService.js` 移至 `services/config/apiKeyService.js`，並更新所有 import 路徑。其餘根層服務（authService、calendarService 等）待後續逐步整理。已完成 2025-01-26。

**目標**

- 統一檔案命名規範和函數命名規範
- 整理 `services/` 目錄結構，移除根層服務檔案

**修改檔案**

- 🔧 整理：`src/services/` 目錄結構
- 將根層服務檔案移至對應子目錄（如 `config/apiKeyService.js`）
- 統一檔案命名（`.jsx` for components, `.js` for services/utils）
- 🔧 整理：函數命名規範
- 統一使用 camelCase，英文命名
- 統一註解格式

**預估影響面**

- 影響檔案數：所有服務檔案
- 只改變檔案位置和命名，不影響功能
- **功能風險**：⭐⭐ (低) - 主要是重構工作

**完成標準**

- 檔案命名規範統一（`.jsx` for components, `.js` for services/utils）
- 函數命名規範統一（camelCase，英文命名）
- `services/` 目錄結構清晰，根層不再有散落的服務檔案
- 所有 import 路徑已更新，功能正常
- 專案結構清晰，易於導航

**自動化程度**

- **🤖 部分可自動重構**
- 建議：使用 VS Code 的重構工具批量更新 import 路徑

---

## 📦 使用者本地硬碟瘦身（已完成）

**背景**：App 為 PWA，且涉及大量影像處理（食物照片辨識、動作分析影片）。針對**使用者本機硬碟**（瀏覽器 Blob、記憶體、Cache 等）瘦身，避免不必要的佔用。**Firebase 容量不納入**，僅處理本機儲存。

### 已實作項目


| 項目                 | 說明                                                                                             | 修改檔案                                             |
| ------------------ | ---------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| **影片 Blob 回收**     | 動作分析影片使用 `URL.createObjectURL` 後，於清除、換檔、FIT 模式、**卸載頁面**時一律 `URL.revokeObjectURL`，釋放本機記憶體／Blob。 | `StrengthAnalysisView.jsx`、`RunAnalysisView.jsx` |
| **CSV 匯出 Blob 回收** | 行事曆匯出、趨勢匯出之 CSV 下載完成後立即 `revokeObjectURL`。                                                     | `CalendarView.jsx`、`TrendAnalysisView.jsx`       |


### 既有狀態（無須變更）

- **Service Worker**（`public/sw.js`）：僅快取 `manifest.json`，不快取 JS/CSS/ 靜態圖；導航與 API 不攔截。已精簡。
- **calendarService 快取**：in-memory `Map`，不寫入本機。
- **食物照片**：僅送 Gemini 辨識，不存本機；`food_logs` 只存營養數字。
- **body_logs**：僅 `date` / `weight` / `bodyFat`，無圖片。
- **localStorage**：僅 API Key、備份摘要等小量資料。

---

## 🎨 UI / 美術設計優化（可選）

### Style 1：Modern Fitness Dark（現代健身深色儀表板）

**目標**

- 打造以「深色為主、強調數據可讀性」的健身儀表板風格

**修改檔案**

- `tailwind.config.js` - 定義色系
- `src/index.css` / `src/App.css` - 設定全域背景和字體
- `src/components/Dashboard/StatCard.jsx`
- `src/views/DashboardView.jsx`
- `src/views/TrainingDashboardView.jsx`

**預估影響面**

- 以「外觀」為主，不改資料流與邏輯，**功能風險低**

---

### Style 2：Glassmorphism AI Panel（AI 教練磨砂玻璃風）

**目標**

- 針對 AI 教練與右下角聊天視窗，採用 Glassmorphism 風格

**修改檔案**

- `src/components/AICoach/CoachChat.jsx`
- `src/layouts/MainLayout.jsx`
- `src/index.css` - 加上 glass 卡片的通用 class

**預估影響面**

- 僅影響 AI 聊天相關 UI 與局部 layout，**功能風險極低**

---

### Style 3：Bento Grid Dashboard（便當盒式模組化卡片）

**目標**

- 將 Dashboard 的各類資訊重新排版成具「Bento Grid」感的模組化卡片

**修改檔案**

- `src/views/DashboardView.jsx`
- `src/components/Dashboard/StatCard.jsx`
- `src/components/Dashboard/AchievementPanel.jsx`
- `src/components/Dashboard/PRTracker.jsx`

**預估影響面**

- 僅改排版與卡片尺寸，不修改資料來源與邏輯，**中低風險**

---

### Style 4：Minimal Health OS（極簡健康作業系統風）

**目標**

- 將 Profile、Nutrition、Calendar 等頁面，往「Health OS / Apple Fitness」那種極簡風格靠攏

**修改檔案**

- `src/views/Profile` 下各子元件
- `src/views/NutritionView.jsx`
- `src/views/CalendarView.jsx`
- `src/layouts/MainLayout.jsx`

**預估影響面**

- 對使用者體感改變較大，但大多是 CSS 級別調整，**功能風險低**

---

## 📅 建議執行順序

### 第一優先（階段二核心任務）

1. **任務 2-1：抽離檔案解析服務**（2-3 天）

- 降低 CalendarView 複雜度，為後續精簡鋪路

1. **任務 2-4：建立響應式 Hooks**（3-4 天）

- 為 View 精簡奠定基礎，實現自動資料同步

1. **任務 2-3：建立 MediaPipe 分析服務**（2-3 天）

- 為分析 View 精簡做準備

### 第二優先（階段三 View 精簡）

1. **任務 3-1：精簡 CalendarView.jsx**（3-4 天）

- 最大型的 View，需要謹慎處理

1. **任務 3-2：精簡分析 View**（2-3 天）

- 依賴任務 2-3 完成

1. **任務 3-3：精簡 DashboardView.jsx**（2-3 天）

- 依賴任務 2-4 完成

### 第三優先（完善與優化）

1. **任務 2-2：驗證 AI JSON 解析統一**（1 天）

- 確保所有 AI 服務使用統一解析

1. **任務 2-5：遷移至統一 API 層**（2-3 天）

- 完善 API 層實作

1. **任務 3-4：統一命名與組織**（1-2 天）

- 整理專案結構

1. **UI 優化**（可選，視時間決定）

- 建議順序：Style 1 → Style 2 → Style 3 → Style 4

---

## ⚠️ 注意事項

1. **測試覆蓋**

- 每次重構後應進行完整的功能測試
- 特別注意 AI 功能、資料同步、錯誤處理

1. **向後相容**

- API 層目前作為轉接層，確保現有功能不受影響
- 逐步遷移，避免大規模一次性變更

1. **文件更新**

- 隨著服務層的建立，應更新相關文件
- 記錄服務的職責和使用方式

1. **Git 策略**

- 每個任務建立獨立 commit
- 使用 Git 分支管理大型重構
- 保留原始邏輯作為備份註解

---

## 📊 預估時間表

- **階段二剩餘工作**：8-12 天
- 任務 2-1：2-3 天
- 任務 2-2：1 天
- 任務 2-3：2-3 天
- 任務 2-4：3-4 天
- 任務 2-5：2-3 天（可與其他任務並行）
- **階段三工作**：7-10 天
- 任務 3-1：3-4 天
- 任務 3-2：2-3 天
- 任務 3-3：2-3 天
- 任務 3-4：1-2 天
- **UI 優化**：可視時間和需求決定優先順序

**總計**：約 3-4 週可完成主要重構工作