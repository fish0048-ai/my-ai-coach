# My AI Coach 專案架構診斷與重構計劃

> 診斷日期：2024-12  
> 專案技術棧：React 18 + Vite + Firebase + Tailwind CSS + Gemini AI + MediaPipe Pose

---

## 1. 目前架構摘要

### 核心架構特徵

1. **技術棧組合**：使用 React 18.3.1 + Vite 作為前端框架，Firebase (Auth + Firestore) 處理後端與認證，整合 Gemini AI 提供智能功能，MediaPipe 進行姿態分析

2. **分層現況**：存在基礎的分層結構（Views / Components / Services / Utils / Hooks），但邊界不夠清晰，仍有業務邏輯與 UI 混合的情況

3. **狀態管理演進**：已導入 Zustand 管理全域狀態（`userStore.js`、`viewStore.js`），但多數 View 組件仍自行管理本地狀態，跨組件資料同步依賴 props 傳遞

4. **Firebase 呼叫模式**：有部分服務層封裝（如 `calendarService.js`、`workoutService.js`），但仍有 12+ 個服務檔案直接使用 `firebase/firestore` API，View 層直接呼叫服務的混合模式

5. **業務邏輯分佈**：統計計算、PR 追蹤、肌肉疲勞度等邏輯已部分抽取至 `workoutService.js`、`statsCalculations.js`，但大型 View（如 `CalendarView.jsx` 639 行）仍包含大量業務邏輯

6. **工具函數統一化**：已完成部分統一化（`utils/date.js`、`utils/number.js`、`utils/aiJson.js`），但部分 View 內部仍有重複的輔助函數定義

7. **API Key 管理**：已建立 `apiKeyService.js` 統一管理，但仍有檔案直接使用 `localStorage.getItem('gemini_api_key')`，遷移不完整

8. **AI 服務組織**：已建立 `services/ai/` 目錄（`workoutGenerator.js`、`nutritionRecommendation.js`、`knowledgeBaseService.js`），但部分 View 仍自行組裝 Prompt 和處理 AI 回應

9. **資料流模式**：部分採用「Service → View」模式，但仍有 View 直接操作 Firestore 的情況，資料流不夠單向和可追蹤

10. **錯誤處理**：已建立 `errorService.js` 統一處理錯誤，但部分舊程式碼仍使用 `try-catch + console.error`，錯誤顯示透過 `ErrorToast` 元件

11. **實時同步**：已使用 `onSnapshot` 實現實時監聽（如 `calendarService.js`、`bodyService.js`），但離線持久化已啟用，資料同步機制基本健全

12. **測試覆蓋**：部分工具函數有單元測試（`workoutCalculations.test.js`、`heartRateCalculations.test.js`），但服務層和 View 層缺乏測試

---

## 2. 最大的 5 個維護痛點

### 🔴 痛點 #1：業務邏輯與 UI 耦合，大型 View 檔案過於臃腫

**問題描述**：
- `CalendarView.jsx` 約 639 行，包含檔案上傳解析、AI 生成、表單驗證、拖曳排序、統計計算等多種職責
- `DashboardView.jsx`、`StrengthAnalysisView.jsx`、`RunAnalysisView.jsx` 等檔案仍包含業務邏輯計算
- 難以獨立測試業務邏輯，修改 UI 可能影響功能

**影響範圍**：
- `CalendarView.jsx`：639 行（包含 FIT/CSV 解析、AI 課表生成、拖曳、統計）
- `RunAnalysisView.jsx`：可能 600+ 行（MediaPipe 整合、AI 分析、評分計算）
- `StrengthAnalysisView.jsx`：可能 400+ 行（姿態分析、AI 建議）

**具體表現**：
```javascript
// CalendarView.jsx 內部仍包含大量業務邏輯
const handleFitAnalysis = async (file) => { /* FIT 解析邏輯 */ }
const handleHeadCoachGenerate = async () => { /* AI Prompt 組裝 */ }
const handleDragEnd = (e) => { /* 拖曳排序邏輯 */ }
```

**重構成本**：⭐⭐⭐⭐ (高) - 需要仔細拆分，避免功能遺漏

---

### 🔴 痛點 #2：Firebase 呼叫分散，缺乏統一的資料存取層

**問題描述**：
- 12+ 個服務檔案直接 import `firebase/firestore`，各自實作查詢邏輯
- `calendarService.js` 已封裝部分 CRUD，但其他服務（如 `nutritionService.js`、`bodyService.js`、`achievementService.js`）各自實作
- 缺乏統一的資料模型轉換、錯誤處理、快取策略

**影響範圍**：
- `src/services/` 下 19 個檔案，多數直接使用 Firestore API
- 查詢邏輯重複（如日期範圍查詢、訂閱實時更新）
- 資料結構變更時需修改多處

**具體表現**：
```javascript
// 多個服務檔案都有類似的查詢邏輯
const q = query(collection(db, 'users', user.uid, 'calendar'), where('date', '>=', startDate));
const snapshot = await getDocs(q);
```

**重構成本**：⭐⭐⭐ (中高) - 需建立統一的 API 層，逐步遷移

---

### 🔴 痛點 #3：狀態管理不統一，跨組件資料同步困難

**問題描述**：
- 雖已導入 Zustand，但僅用於 `userData` 和 `viewStore`，多數資料仍由 View 組件自行管理
- `CalendarView` 更新訓練記錄後，`DashboardView` 不會自動刷新統計
- AI Context 更新邏輯散落各處（`updateAIContext` 在 10+ 處直接呼叫）

**影響範圍**：
- 資料不一致：Calendar 更新後 Dashboard 顯示舊資料
- 手動刷新：需在 `useEffect` 中手動呼叫 `fetchWorkoutStats()`
- 無法追蹤：無法清楚追蹤資料流和更新來源

**具體表現**：
```javascript
// DashboardView.jsx 需要手動觸發更新
useEffect(() => {
  fetchWorkoutStats();
}, [userData]); // 無法自動響應 Calendar 的變更

// CalendarView.jsx 更新後需手動同步
await updateCalendarWorkout(id, data);
await updateAIContext(); // 手動觸發
```

**重構成本**：⭐⭐⭐ (中高) - 需建立響應式資料流和統一狀態管理

---

### 🔴 痛點 #4：AI 服務遷移不完整，Prompt 組裝邏輯分散

**問題描述**：
- 已建立 `services/ai/workoutGenerator.js`、`nutritionRecommendation.js`，但部分 View 仍自行組裝 Prompt
- `CoachChat.jsx` 內含對話邏輯，未完全抽離至服務層
- Prompt 模板散落各處，難以統一管理和優化

**影響範圍**：
- `CoachChat.jsx`：仍包含大量 Prompt 組裝邏輯
- `StrengthAnalysisView.jsx`、`RunAnalysisView.jsx`：可能仍有自定義的 AI 呼叫邏輯
- 難以統一管理 AI 回應格式和錯誤處理

**具體表現**：
```javascript
// 可能存在多處類似的 Prompt 組裝
const prompt = `你是我的健身教練，用戶資料：${userData}，最近訓練：${recentWorkouts}...`;
const response = await runGemini(prompt);
```

**重構成本**：⭐⭐⭐ (中) - 需抽離 Prompt 模板，統一 AI 服務介面

---

### 🔴 痛點 #5：命名與組織不一致，新舊程式碼風格混雜

**問題描述**：
- 檔案命名：部分使用 `.jsx`，部分使用 `.js`，缺乏統一規則
- 函數命名：混用中英文註解和變數名，如 `fetchMonthWorkouts` vs `獲取月度訓練`
- 目錄結構：`services/ai/`、`services/import/` 子目錄，但部分服務仍在根層
- 部分已完成重構（如 `date.js`、`number.js`），部分仍使用舊模式

**影響範圍**：
- 新開發者難以快速理解專案結構
- 重構進度不一致，新舊模式並存造成混淆
- 難以判斷應該使用哪種模式（新服務層 vs 直接呼叫 Firebase）

**具體表現**：
- `utils/date.js` ✅ 已完成統一
- `utils/number.js` ✅ 已完成統一
- 但 `CalendarView.jsx` 內可能仍有舊的日期處理邏輯
- `apiKeyService.js` ✅ 已建立，但部分檔案可能仍直接使用 `localStorage`

**重構成本**：⭐⭐ (中低) - 主要是整理和遷移工作

---

## 3. 建議目標架構

### 資料夾結構（tree -L 3）

```
my-ai-coach/
├── src/
│   ├── api/                          # 🔵 API 服務層（Firebase 封裝）
│   │   ├── firebase.js              # Firebase 初始化與配置
│   │   ├── auth.js                  # 認證服務（signIn, signOut）
│   │   ├── workouts.js              # 訓練資料 CRUD（統一介面）
│   │   ├── nutrition.js             # 營養紀錄 CRUD
│   │   ├── body.js                  # 身體數據 CRUD
│   │   ├── gears.js                 # 裝備管理 CRUD
│   │   └── achievements.js          # 成就系統 CRUD
│   │
│   ├── services/                     # 🟢 業務邏輯服務層
│   │   ├── ai/                      # AI 相關服務
│   │   │   ├── coachService.js      # AI 教練對話（抽離 CoachChat 邏輯）
│   │   │   ├── workoutGenerator.js  # ✅ 已存在
│   │   │   ├── nutritionRecommendation.js  # ✅ 已存在
│   │   │   ├── analysisService.js   # 動作分析 AI
│   │   │   ├── formCorrection.js    # ✅ 已存在
│   │   │   ├── knowledgeBaseService.js  # ✅ 已存在
│   │   │   └── prompts/             # Prompt 模板目錄
│   │   │       ├── coachPrompts.js
│   │   │       └── workoutPrompts.js
│   │   ├── workout/                 # 訓練領域服務
│   │   │   ├── workoutService.js    # ✅ 已存在（統計聚合）
│   │   │   ├── prService.js         # PR 追蹤服務（從 calendarService 抽離）
│   │   │   └── statsService.js      # 統計計算服務
│   │   ├── analysis/                # 分析相關服務
│   │   │   ├── poseAnalysis.js      # MediaPipe 姿態分析封裝
│   │   │   └── metricsCalculator.js # 評分計算邏輯
│   │   ├── import/                  # 匯入相關服務
│   │   │   ├── fitParser.js         # FIT 檔案解析
│   │   │   ├── csvParser.js         # CSV 匯入解析
│   │   │   └── platformSync.js      # ✅ 已存在
│   │   ├── config/                  # 配置管理
│   │   │   └── apiKeyService.js     # ✅ 已存在
│   │   ├── aiContextService.js      # ✅ 已存在（AI Context 管理）
│   │   ├── errorService.js          # ✅ 已存在
│   │   └── backupService.js         # ✅ 已存在
│   │
│   ├── hooks/                        # 🟡 自訂 Hooks（業務邏輯抽離）
│   │   ├── useAuth.js               # 認證狀態 Hook（封裝 userStore）
│   │   ├── useWorkouts.js           # 訓練資料 Hook（響應式資料流）
│   │   ├── useNutrition.js          # 營養紀錄 Hook
│   │   ├── useGears.js              # 裝備管理 Hook
│   │   ├── usePoseDetection.js      # ✅ 已存在
│   │   ├── useUserData.js           # ✅ 已存在
│   │   ├── useApiKey.js             # API Key 管理 Hook
│   │   └── useAIContext.js          # AI Context 同步 Hook
│   │
│   ├── utils/                        # 🟣 純函數工具庫
│   │   ├── date.js                  # ✅ 已存在
│   │   ├── number.js                # ✅ 已存在
│   │   ├── aiJson.js                # ✅ 已存在
│   │   ├── formValidation.js        # ✅ 已存在
│   │   ├── exerciseDB.js            # ✅ 已存在
│   │   ├── contextManager.js        # ✅ 已存在
│   │   ├── gemini.js                # ✅ 已存在
│   │   ├── statsCalculations.js     # ✅ 已存在
│   │   ├── workoutCalculations.js   # ✅ 已存在
│   │   ├── nutritionCalculations.js # ✅ 已存在
│   │   ├── heartRateCalculations.js # ✅ 已存在
│   │   ├── trendCalculations.js     # ✅ 已存在
│   │   ├── cycleAnalysis.js         # ✅ 已存在
│   │   ├── importHelpers.js         # ✅ 已存在（待重構）
│   │   ├── reportGenerator.js       # ✅ 已存在
│   │   └── aiPrompts.js             # ✅ 已存在
│   │
│   ├── store/                        # 🔴 狀態管理（Zustand）
│   │   ├── userStore.js             # ✅ 已存在
│   │   ├── viewStore.js             # ✅ 已存在
│   │   └── workoutStore.js          # 🆕 訓練資料狀態（響應式）
│   │
│   ├── components/                   # 🟠 UI 元件（僅展示邏輯）
│   │   ├── AICoach/
│   │   │   └── CoachChat.jsx        # 精簡：僅 UI，業務邏輯移至 coachService
│   │   ├── Calendar/
│   │   │   ├── WorkoutForm.jsx      # ✅ 已存在
│   │   │   ├── WeeklyModal.jsx      # ✅ 已存在
│   │   │   └── WorkoutCard.jsx      # 🆕 訓練卡片元件（可重用）
│   │   ├── Dashboard/
│   │   │   ├── StatCard.jsx         # ✅ 已存在
│   │   │   ├── PRTracker.jsx        # ✅ 已存在
│   │   │   └── AchievementPanel.jsx # ✅ 已存在
│   │   ├── Profile/
│   │   │   └── [6 files]            # ✅ 已存在
│   │   ├── common/
│   │   │   ├── ErrorToast.jsx       # ✅ 已存在
│   │   │   └── Skeleton.jsx         # ✅ 已存在
│   │   ├── BodyHeatmap.jsx          # ✅ 已存在
│   │   └── WeatherWidget.jsx       # ✅ 已存在
│   │
│   ├── views/                        # 🟡 頁面視圖（僅組合元件與 Hook）
│   │   ├── DashboardView.jsx        # 精簡：200-250 行（移除業務邏輯）
│   │   ├── CalendarView.jsx         # 精簡：200-300 行（移除 FIT/CSV 解析、AI 生成）
│   │   ├── TrainingDashboardView.jsx
│   │   ├── TrendAnalysisView.jsx
│   │   ├── NutritionView.jsx
│   │   ├── GearView.jsx
│   │   ├── StrengthAnalysisView.jsx # 精簡：150-200 行（移除 MediaPipe 邏輯）
│   │   ├── RunAnalysisView.jsx      # 精簡：150-200 行
│   │   ├── TrainingPlanView.jsx
│   │   ├── KnowledgeBaseView.jsx
│   │   └── FeatureViews.jsx
│   │
│   ├── layouts/
│   │   └── MainLayout.jsx           # ✅ 已存在
│   │
│   ├── App.jsx                       # 路由與 Layout 組合
│   ├── main.jsx                      # ✅ 已存在
│   └── index.css                     # ✅ 已存在
│
└── [其他配置檔案]
```

### 核心原則

- **清晰分層**：API → Services → Hooks → Views，單向依賴
- **單一職責**：每個模組只做一件事，易於測試和維護
- **資料流單向**：Views 透過 Hooks 取得資料，Hooks 透過 Services 操作，Services 透過 API 存取資料庫
- **響應式更新**：使用 Zustand store 和實時訂閱，資料變更時 UI 自動更新

---

## 4. 重構路線圖（分 3 個階段）

### 階段一：基礎設施完善與低風險遷移（2-3 天）

**目標**：完善工具庫，統一配置管理，建立 API 層骨架

**任務順序**：

1. **完善工具庫** (`src/utils/`)
   - ✅ `date.js`、`number.js` 已完成
   - ✅ `aiJson.js` 已完成
   - 🔧 檢查並移除 View 內部的重複工具函數
   - 🔧 統一 `importHelpers.js` 的函數命名和組織

2. **統一 API Key 管理**
   - ✅ `apiKeyService.js` 已建立
   - 🔧 搜尋並替換所有 `localStorage.getItem('gemini_api_key')` 為 `getApiKey()`
   - 🔧 建立 `hooks/useApiKey.js` Hook
   - 驗證：所有 AI 功能正常運作

3. **建立 API 層骨架** (`src/api/`)
   - 🆕 `api/firebase.js`：重新匯出 `firebase.js`（保持相容）
   - 🆕 `api/auth.js`：封裝認證服務（從 `authService.js` 遷移）
   - 🆕 `api/workouts.js`：封裝訓練資料 CRUD（從 `calendarService.js` 抽象）
   - 🆕 `api/nutrition.js`、`api/body.js`、`api/gears.js`：建立骨架
   - 驗證：與現有服務並行運作，不影響功能

4. **抽離 PR 服務**
   - 🔧 從 `calendarService.js` 抽出 `extractPRs`、`getAllPRs` 至 `services/workout/prService.js`
   - 🔧 更新 `DashboardView.jsx`、`PRTracker.jsx` 使用新服務

**風險等級**：⭐ (低) - 主要是新增檔案和低風險遷移

---

### 階段二：業務邏輯抽離與服務層建立（5-7 天）

**目標**：將業務邏輯從 View 移至 Services，建立響應式資料流

**任務順序**：

5. **抽離檔案解析服務** (`src/services/import/`)
   - 🔧 從 `CalendarView.jsx` 抽出 `handleFitAnalysis` 至 `services/import/fitParser.js`
   - 🔧 從 `CalendarView.jsx` 抽出 `handleCSVUpload` 至 `services/import/csvParser.js`
   - 🔧 更新 `CalendarView.jsx` 使用新服務
   - 驗證：FIT/CSV 匯入功能正常

6. **完善 AI 服務**
   - ✅ `workoutGenerator.js`、`nutritionRecommendation.js` 已存在
   - 🔧 從 `CoachChat.jsx` 抽出對話邏輯至 `services/ai/coachService.js`
   - 🔧 建立 `services/ai/prompts/` 目錄，統一管理 Prompt 模板
   - 🔧 從 `StrengthAnalysisView.jsx`、`RunAnalysisView.jsx` 抽出 AI 分析邏輯
   - 驗證：所有 AI 功能正常

7. **建立 MediaPipe 分析服務** (`src/services/analysis/`)
   - 🔧 從 `StrengthAnalysisView.jsx`、`RunAnalysisView.jsx` 抽出 MediaPipe 邏輯至 `services/analysis/poseAnalysis.js`
   - 🔧 抽出評分計算邏輯至 `services/analysis/metricsCalculator.js`
   - 驗證：姿態分析功能正常

8. **建立響應式 Hooks**
   - 🆕 `hooks/useWorkouts.js`：封裝訓練資料訂閱，自動更新 UI
   - 🆕 `hooks/useNutrition.js`：封裝營養紀錄訂閱
   - 🆕 `hooks/useGears.js`：封裝裝備管理
   - 🆕 `store/workoutStore.js`：訓練資料狀態（響應式）
   - 驗證：資料變更時 UI 自動更新

9. **遷移至統一 API 層**
   - 🔧 逐步將 `calendarService.js`、`nutritionService.js` 等改為使用 `api/*` 層
   - 🔧 統一錯誤處理、快取策略
   - 驗證：功能不變，但資料存取統一

**風險等級**：⭐⭐⭐ (中) - 需確保功能完整性，逐頁遷移並測試

---

### 階段三：大型 View 精簡與架構收斂（5-7 天）

**目標**：大幅精簡 View 組件，移除業務邏輯，僅保留 UI 組合

**任務順序**：

10. **精簡 CalendarView.jsx**
    - 🔧 移除 FIT/CSV 解析邏輯（改用 `fitParser.js`、`csvParser.js`）
    - 🔧 移除 AI 生成邏輯（改用 `workoutGenerator.js`）
    - 🔧 移除日期/數值處理（改用 `utils/date.js`、`utils/number.js`）
    - 🔧 移除 Firebase 直接呼叫（改用 `useWorkouts` Hook）
    - 🔧 抽出 `WorkoutCard` 元件（可重用）
    - 目標：從 639 行降至 200-300 行
    - 驗證：完整測試所有功能（CRUD、拖曳、AI 生成、匯入）

11. **精簡 StrengthAnalysisView.jsx 與 RunAnalysisView.jsx**
    - 🔧 移除 MediaPipe 邏輯（改用 `poseAnalysis.js`）
    - 🔧 移除評分計算（改用 `metricsCalculator.js`）
    - 🔧 移除 AI 分析邏輯（改用 `analysisService.js`）
    - 目標：各從 400-600 行降至 150-200 行
    - 驗證：姿態分析、AI 建議、儲存功能正常

12. **精簡 DashboardView.jsx**
    - ✅ 已使用 `workoutService.js` 取得統計
    - 🔧 移除手動 `fetchWorkoutStats`（改用響應式 `useWorkouts`）
    - 🔧 簡化狀態管理（改用 store）
    - 目標：從 500+ 行降至 200-250 行
    - 驗證：統計數據、肌肉熱圖、今日課表正常

13. **統一命名與組織**
    - 🔧 統一檔案命名規範（`.jsx` for components, `.js` for services/utils）
    - 🔧 統一函數命名規範（camelCase，英文命名）
    - 🔧 整理 `services/` 目錄結構，移除根層服務檔案
    - 驗證：專案結構清晰，易於導航

**風險等級**：⭐⭐⭐⭐ (高) - 大型組件修改，容易遺漏細節

---

## 5. 風險清單與驗證方式

### 🔴 高風險項目

#### 1. CalendarView.jsx 重構（階段三 #10）

**風險原因**：639 行，包含最複雜的業務邏輯（拖曳、匯入、AI 生成）

**可能問題**：
- 拖曳排序功能失效
- AI 生成課表格式錯誤
- FIT/CSV 匯入失敗
- 日期計算錯誤（時區問題）
- 資料同步問題（更新後 Dashboard 不刷新）

**驗證清單**：
- [ ] 新增/編輯/刪除訓練紀錄
- [ ] 拖曳移動訓練到不同日期
- [ ] Ctrl+拖曳複製訓練
- [ ] AI 生成單日課表（重訓/跑步）
- [ ] AI 生成本週課表（多選模式）
- [ ] 匯入 FIT 檔案（Garmin/Strava）
- [ ] 匯入 CSV 檔案
- [ ] 匯出 CSV 備份
- [ ] 更新後 Dashboard 自動刷新
- [ ] 切換月份顯示正常

**防護措施**：
- 使用 Git 分支，保留原版對照
- 逐小塊重構，每次修改後立即測試
- 建立測試清單，逐項勾選
- 保留原始邏輯作為註解，方便回溯

---

#### 2. Firebase API 層封裝（階段二 #9）

**風險原因**：資料庫操作，錯誤會導致資料遺失或損壞

**可能問題**：
- 查詢條件錯誤，資料不完整
- 更新邏輯錯誤，覆蓋錯誤欄位
- 訂閱邏輯錯誤，實時更新失效
- 快取策略錯誤，顯示舊資料
- 權限設定錯誤，無法讀寫

**驗證清單**：
- [ ] 讀取訓練資料（單日/月範圍/日期範圍）
- [ ] 新增訓練（重訓/跑步）
- [ ] 更新訓練狀態（`planned` → `completed`）
- [ ] 刪除訓練
- [ ] 讀取使用者資料（`users/{uid}`）
- [ ] 子集合操作（`calendar`、`food_logs`、`gears`）
- [ ] 實時訂閱正常（多分頁同步）
- [ ] 離線模式正常（快取讀取）

**防護措施**：
- 保留原 Firebase 調用作為備份註解
- 先建立服務函數，確認行為一致後再替換
- 使用 Firebase Console 檢查資料完整性
- 對比重構前後的資料查詢結果

---

#### 3. AI 服務抽離（階段二 #6）

**風險原因**：Gemini API 調用，錯誤會影響核心功能

**可能問題**：
- Prompt 格式錯誤，AI 回應異常
- JSON 解析失敗（已有 `aiJson.js`，需確認使用）
- API Key 管理錯誤，無法調用
- Context 組裝錯誤，回應不準確
- 錯誤處理不統一，使用者體驗差

**驗證清單**：
- [ ] AI 教練對話（簡單問題/複雜問題）
- [ ] 生成單日課表（重訓/跑步）
- [ ] 生成本週課表（多選模式）
- [ ] 食物圖片辨識
- [ ] 營養建議生成
- [ ] 動作分析建議（重訓/跑步）
- [ ] API Key 錯誤時顯示友好提示
- [ ] 網路錯誤時正確處理

**防護措施**：
- 保留原始 Prompt 作為註解
- 使用相同的 API Key 測試
- 對照原始回應格式
- 建立 Prompt 模板庫，統一管理

---

#### 4. 響應式資料流建立（階段二 #8）

**風險原因**：狀態管理變更，可能導致 UI 不更新或無限迴圈

**可能問題**：
- `useEffect` 依賴錯誤，無限迴圈
- 狀態更新時機錯誤，UI 顯示舊資料
- 取消訂閱邏輯錯誤，記憶體洩漏
- Store 更新不觸發 UI 重新渲染
- 多個組件訂閱同一資料，效能問題

**驗證清單**：
- [ ] `useWorkouts`：資料更新時 UI 自動刷新
- [ ] `useApiKey`：API Key 變更時所有使用處同步更新
- [ ] 組件卸載時正確取消訂閱
- [ ] Calendar 更新後 Dashboard 自動刷新
- [ ] 多分頁同步正常
- [ ] 無記憶體洩漏（長時間使用）

**防護措施**：
- 使用 React DevTools 檢查狀態更新
- 檢查 Console 是否有警告訊息
- 測試快速切換頁面（檢查記憶體）
- 使用 `useEffect` cleanup 函數確保取消訂閱

---

### 🟡 中風險項目

#### 5. 工具函數統一（階段一 #1）

**風險原因**：多處使用，替換錯誤會導致計算錯誤

**可能問題**：
- 日期格式不一致（時區問題）
- 數值解析錯誤（空值處理）
- 函數簽名改變，呼叫處未更新
- 邊界情況處理不同

**驗證清單**：
- [ ] `formatDate`：測試各種日期格式（Date 物件、字串、null）
- [ ] `cleanNumber`：測試字串/數字/空值/特殊字元
- [ ] `parsePaceToDecimal`：測試 "5'30\"" 格式、空值、錯誤格式
- [ ] 時區處理：確認日期計算不受時區影響

**防護措施**：
- 使用 `grep` 找出所有使用處
- 建立測試腳本驗證函數行為
- 逐一替換並測試
- 對比重構前後的輸出結果

---

#### 6. MediaPipe 邏輯抽離（階段二 #7）

**風險原因**：複雜的姿態分析邏輯，錯誤會導致分析失效

**可能問題**：
- 姿態偵測失敗
- 評分計算錯誤
- 影片處理錯誤
- 效能問題（過度重新渲染）

**驗證清單**：
- [ ] 姿態偵測正常（重訓/跑步動作）
- [ ] 評分計算準確
- [ ] AI 分析建議正常
- [ ] 儲存功能正常
- [ ] 效能正常（無卡頓）

**防護措施**：
- 保留原始邏輯作為註解
- 對比抽離前後的結果
- 測試多種動作類型

---

### 🟢 低風險項目

#### 7. 元件抽離（階段三）

**風險原因**：UI 調整，功能不受影響

**驗證清單**：
- [ ] 視覺效果與原版一致
- [ ] 事件處理正常（點擊、輸入、拖曳）
- [ ] 響應式設計正常（手機/平板/桌機）

---

## 總結建議

### 優先順序

1. **階段一**（必做）：完善基礎設施，為後續重構鋪路（2-3 天）
2. **階段二**（重要）：逐步抽離業務邏輯，降低風險（5-7 天）
3. **階段三**（謹慎）：大型組件重構，需充分測試（5-7 天）

### 建議策略

- **並行開發**：新服務與舊程式碼並存，逐步遷移，避免大爆炸式重構
- **小步快跑**：每次改動後立即測試，避免累積大量改動
- **保留備份**：重要檔案保留原始版本作為參考，使用 Git 分支管理
- **文件化**：記錄每個服務的職責與使用方式，便於後續維護

### 時間預估

- **階段一**：2-3 天（低風險，可快速完成）
- **階段二**：5-7 天（中風險，需仔細測試）
- **階段三**：5-7 天（高風險，需充分驗證）
- **總計**：約 2-3 週（包含測試與除錯時間）

### 成功標準

- [ ] 所有大型 View 檔案行數降至 200-300 行以下
- [ ] 所有業務邏輯集中在 Services 層
- [ ] 所有 Firebase 呼叫統一透過 API 層
- [ ] 資料變更時 UI 自動響應更新
- [ ] 所有功能在重構後正常運作
- [ ] 專案結構清晰，易於導航和維護

---

**報告結束**
